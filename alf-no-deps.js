/*!
 * textFit.js
 *
 * Copyright 2011, Peter Rudolfsen
 */

/**
 * Swiper.js
 * Copyright 2012 Peter Rudolfsen <peter@aptoma.com>
 */

/** @license MIT License (c) copyright B Cavalier & J Hann */

/**
 * A lightweight CommonJS Promises/A and when() implementation
 * when is part of the cujo.js family of libraries (http://cujojs.com/)
 *
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @version 1.7.1
 */

/**
 * Alf - Aptoma Layout Framework
 *
 * @copyright 2012-2013 Aptoma AS aptoma.com
 * @author Peter Rudolfsen <peter@aptoma.com>
 */

function md5cycle(e,t){var n=e[0],r=e[1],i=e[2],s=e[3];n=ff(n,r,i,s,t[0],7,-680876936),s=ff(s,n,r,i,t[1],12,-389564586),i=ff(i,s,n,r,t[2],17,606105819),r=ff(r,i,s,n,t[3],22,-1044525330),n=ff(n,r,i,s,t[4],7,-176418897),s=ff(s,n,r,i,t[5],12,1200080426),i=ff(i,s,n,r,t[6],17,-1473231341),r=ff(r,i,s,n,t[7],22,-45705983),n=ff(n,r,i,s,t[8],7,1770035416),s=ff(s,n,r,i,t[9],12,-1958414417),i=ff(i,s,n,r,t[10],17,-42063),r=ff(r,i,s,n,t[11],22,-1990404162),n=ff(n,r,i,s,t[12],7,1804603682),s=ff(s,n,r,i,t[13],12,-40341101),i=ff(i,s,n,r,t[14],17,-1502002290),r=ff(r,i,s,n,t[15],22,1236535329),n=gg(n,r,i,s,t[1],5,-165796510),s=gg(s,n,r,i,t[6],9,-1069501632),i=gg(i,s,n,r,t[11],14,643717713),r=gg(r,i,s,n,t[0],20,-373897302),n=gg(n,r,i,s,t[5],5,-701558691),s=gg(s,n,r,i,t[10],9,38016083),i=gg(i,s,n,r,t[15],14,-660478335),r=gg(r,i,s,n,t[4],20,-405537848),n=gg(n,r,i,s,t[9],5,568446438),s=gg(s,n,r,i,t[14],9,-1019803690),i=gg(i,s,n,r,t[3],14,-187363961),r=gg(r,i,s,n,t[8],20,1163531501),n=gg(n,r,i,s,t[13],5,-1444681467),s=gg(s,n,r,i,t[2],9,-51403784),i=gg(i,s,n,r,t[7],14,1735328473),r=gg(r,i,s,n,t[12],20,-1926607734),n=hh(n,r,i,s,t[5],4,-378558),s=hh(s,n,r,i,t[8],11,-2022574463),i=hh(i,s,n,r,t[11],16,1839030562),r=hh(r,i,s,n,t[14],23,-35309556),n=hh(n,r,i,s,t[1],4,-1530992060),s=hh(s,n,r,i,t[4],11,1272893353),i=hh(i,s,n,r,t[7],16,-155497632),r=hh(r,i,s,n,t[10],23,-1094730640),n=hh(n,r,i,s,t[13],4,681279174),s=hh(s,n,r,i,t[0],11,-358537222),i=hh(i,s,n,r,t[3],16,-722521979),r=hh(r,i,s,n,t[6],23,76029189),n=hh(n,r,i,s,t[9],4,-640364487),s=hh(s,n,r,i,t[12],11,-421815835),i=hh(i,s,n,r,t[15],16,530742520),r=hh(r,i,s,n,t[2],23,-995338651),n=ii(n,r,i,s,t[0],6,-198630844),s=ii(s,n,r,i,t[7],10,1126891415),i=ii(i,s,n,r,t[14],15,-1416354905),r=ii(r,i,s,n,t[5],21,-57434055),n=ii(n,r,i,s,t[12],6,1700485571),s=ii(s,n,r,i,t[3],10,-1894986606),i=ii(i,s,n,r,t[10],15,-1051523),r=ii(r,i,s,n,t[1],21,-2054922799),n=ii(n,r,i,s,t[8],6,1873313359),s=ii(s,n,r,i,t[15],10,-30611744),i=ii(i,s,n,r,t[6],15,-1560198380),r=ii(r,i,s,n,t[13],21,1309151649),n=ii(n,r,i,s,t[4],6,-145523070),s=ii(s,n,r,i,t[11],10,-1120210379),i=ii(i,s,n,r,t[2],15,718787259),r=ii(r,i,s,n,t[9],21,-343485551),e[0]=add32(n,e[0]),e[1]=add32(r,e[1]),e[2]=add32(i,e[2]),e[3]=add32(s,e[3])}function cmn(e,t,n,r,i,s){return t=add32(add32(t,e),add32(r,s)),add32(t<<i|t>>>32-i,n)}function ff(e,t,n,r,i,s,o){return cmn(t&n|~t&r,e,t,i,s,o)}function gg(e,t,n,r,i,s,o){return cmn(t&r|n&~r,e,t,i,s,o)}function hh(e,t,n,r,i,s,o){return cmn(t^n^r,e,t,i,s,o)}function ii(e,t,n,r,i,s,o){return cmn(n^(t|~r),e,t,i,s,o)}function md51(e){txt="";var t=e.length,n=[1732584193,-271733879,-1732584194,271733878],r;for(r=64;r<=e.length;r+=64)md5cycle(n,md5blk(e.substring(r-64,r)));e=e.substring(r-64);var i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(r=0;r<e.length;r++)i[r>>2]|=e.charCodeAt(r)<<(r%4<<3);i[r>>2]|=128<<(r%4<<3);if(r>55){md5cycle(n,i);for(r=0;r<16;r++)i[r]=0}return i[14]=t*8,md5cycle(n,i),n}function md5blk(e){var t=[],n;for(n=0;n<64;n+=4)t[n>>2]=e.charCodeAt(n)+(e.charCodeAt(n+1)<<8)+(e.charCodeAt(n+2)<<16)+(e.charCodeAt(n+3)<<24);return t}function rhex(e){var t="",n=0;for(;n<4;n++)t+=hex_chr[e>>n*8+4&15]+hex_chr[e>>n*8&15];return t}function hex(e){for(var t=0;t<e.length;t++)e[t]=rhex(e[t]);return e.join("")}function md5(e){return hex(md51(e))}function add32(e,t){return e+t&4294967295}define("modules/tap",["require","zepto"],function(e){function s(e){return"tagName"in e?e:e.parentNode}function o(e,t,n,r){var i=Math.abs(e-t),s=Math.abs(n-r);return i>=s?e-t>0?"Left":"Right":n-r>0?"Up":"Down"}function a(e){e=u[e],e.timeout&&clearTimeout(e.timeout),e.timeout=null}function f(){u.longTap.timeout=null,n.last&&(n.el.trigger("longTap"),n={})}function l(){u.active.timeout=null,n.last&&n.el.trigger("active")}function c(){a("longTap")}function h(){a("active")}var t=e("zepto"),n={},r,i,u={longTap:{delay:750},active:{delay:0}};t(document).ready(function(){var e,a,p,d,v,m=!1,g="ontouchstart"in window,y="touchstart",b="touchmove",w="touchend";g||(y="mousedown",b="mousemove",w="mouseup"),t(document.body).bind(y,function(i){i=i.originalEvent||i,m=!0,v=g?i.touches[0]:i,e=Date.now(),a=e-(n.last||e),n.el=t(s(v.target)),r&&clearTimeout(r),n.x1=v.pageX,n.y1=v.pageY,n.x2=v.pageX,n.y2=v.pageY,a>0&&a<=250&&(n.isDoubleTap=!0),n.last=e,u.longTap.timeout=setTimeout(f,u.longTap.delay),u.active.timeout=setTimeout(l,u.active.delay)}).bind(b,function(e){if(!m)return;e=e.originalEvent||e,h(),c(),v=g?e.touches[0]:e,n.x2=v.pageX,n.y2=v.pageY,document.webkitPointerLockElement&&(m=!1)}).bind(w,function(e){if(!m)return;m=!1,c(),h(),p=Math.abs(n.x1-n.x2),d=Math.abs(n.y1-n.y2),n.isDoubleTap?(n.el.trigger("doubleTap",n.el),n={}):p>30||d>30?(n.el.trigger("swipe")&&n.el.trigger("swipe"+o(n.x1,n.x2,n.y1,n.y2)),n={}):"last"in n&&p<7&&d<7&&(n.el.trigger("tap"),r=setTimeout(function(){r=null,n.el.trigger("singleTap"),n={}},250))}).bind("touchcancel",function(){r&&clearTimeout(r),i&&clearTimeout(i),i=r=null,n={}})})}),define("dimensions",["require","zepto"],function(e){function n(e,t){return parseInt(e.getPropertyValue(t),10)}var t=e("zepto");t.fn.outerHeight=function(){var e=this[0],n=t.fn.marginHeight.call(this);return e.offsetHeight+n},t.fn.marginHeight=function(){var e=t.fn.margin.call(this);return e.top+e.bottom},t.fn.margin=function(){var e=this[0],t=window.getComputedStyle(e,null),r;return r={top:n(t,"margin-top"),right:n(t,"margin-right"),bottom:n(t,"margin-bottom"),left:n(t,"margin-left")},r.height=r.top+r.bottom,r.width=r.left+r.right,r},t.fn.padding=function(){var e=this[0],t=window.getComputedStyle(e,null);return{top:n(t,"padding-top"),right:n(t,"padding-right"),bottom:n(t,"padding-bottom"),left:n(t,"padding-left")}},t.fn.metrics=function(){var e=this[0],n=e.getBoundingClientRect(),r=t.fn.margin.call(this),i=t.fn.padding.call(this);return{height:e.clientHeight,width:e.clientWidth,top:n.top,right:n.right,bottom:n.bottom,left:n.left,outerHeight:n.height+r.height,outerWidth:n.width+r.width,marginTop:r.top,marginRight:r.right,marginBottom:r.bottom,marginLeft:r.left,marginHeight:r.height,marginWidth:r.width,paddingTop:i.top,paddingRight:i.right,paddingBottom:i.bottom,paddingLeft:i.left,lineHeight:parseInt(t.fn.css.call(this,"line-height"),10)}}}),define("textfit",["require","zepto"],function(e){var t=e("zepto");t.fn.textFit=function(e){return this.each(function(){var e=t(this),n=n||1,r=t('<span style="display:inline-block;margin:0;padding:0;"></span>').html(e.text()),i=parseInt(window.getComputedStyle(this).getPropertyValue("font-size"),10),s=e.width(),o=0;if(s===0)return;e.empty().append(r),o=r.width(),o>=s&&(i=8,e.css("font-size",i+"px"),o=r.width());while(o<s)i+=1,e.css("font-size",i+"px"),o=r.width(),s=e.width();o>=s&&(i-=1),e.css("font-size",i/n+"px")})}}),define("modules/dom",["zepto","modules/tap","dimensions","textfit"],function(e){return e}),define("modules/hub",["require","underscore","backbone"],function(e){var t=e("underscore"),n=e("backbone");return t.extend({},n.Events)}),define("modules/Base",["require","backbone"],function(e){var t=e("backbone"),n=function(){this.initialize.apply(this,arguments)};return n.prototype={initialize:function(){}},n.extend=t.Model.extend,n}),define("modules/classnames",["require"],function(e){return{ALLOW_MULTIPLE:"alf-allow-multiple",ALLOW_OVERFLOW:"alf-allow-overflow",ASSET_STYLESHEET:"alf-asset-stylesheet",BREAK_BEFORE:"alf-break-before",BTN_GROUP:"alf-btn-group",CONTAINER:"alf-container",CONTAINER_FULLSCREEN:"alf-container-fullscreen",CONTAINER_INLINE:"alf-container-inline",CONTAINER_IS_UNLOADED:"alf-container-is-unloaded",CONTROLS_OFF:"alf-controls-off",FULLSCREEN_CONTENT:"alf-fullscreen-content",FULLSCREEN_EXIT:"alf-fullscreen-exit",FULLSCREEN_TOOLBAR:"alf-fullscreen-toolbar",IS_BREAKABLE:"alf-is-breakable",IS_DISABLED:"alf-is-disabled",IS_DRAGGABLE:"alf-is-draggable",IS_DRAGGABLE_X:"alf-is-draggable-x",IS_DRAGGABLE_Y:"alf-is-draggable-y",IS_EDITABLE:"alf-is-editable",IS_HIDDEN:"alf-is-hidden",IS_LAST_BLOCK:"alf-block-is-last",IS_NON_BREAKABLE:"alf-is-non-breakable",IS_NON_REARRANGEABLE:"alf-is-non-rearrangeable",IS_NON_SPLITTABLE:"alf-is-non-splittable",IS_OPTIONAL:"alf-is-optional",IS_PLAYING:"alf-is-playing",IS_REARRANGEABLE:"alf-is-rearrangeable",IS_REMOVABLE:"alf-is-removable",IS_REMOVED:"alf-is-removed",IS_RESPONSIVE:"alf-is-responsive",IS_RESIZABLE:"alf-is-resizable",IS_SPLITTABLE:"alf-is-splittable",IS_VISIBLE:"alf-is-visible",NO_SCORE:"alf-no-score",PAGENUM_X:function(e){return"alf-pagenum-"+e},PAGENUM_TOTAL_X:function(e){return"alf-pagenum-total-"+e},REVISION:function(e){return"alf-rev-"+e},REGION:"alf-region",REGION_FLEXIBLE:"alf-region-flexible",SIZE_DETECTOR:"alf-size-detector",STICK_TO_NEXT:"alf-stick-to-next",STRETCH_TO_FIT:"alf-stretch-to-fit",SUPPORTS_FULLSCREEN:"alf-supports-fullscreen",WIDGET:"alf-widget"}});var hex_chr="0123456789abcdef".split("");if(md5("hello")!="5d41402abc4b2a76b9719d911017c592")function add32(e,t){var n=(e&65535)+(t&65535),r=(e>>16)+(t>>16)+(n>>16);return r<<16|n&65535}define("vendor/md5",function(){}),define("md5",["vendor/md5"],function(){return window.md5}),define("modules/BaseView",["require","modules/dom","underscore","backbone","modules/classnames","md5"],function(e){var t=e("modules/dom"),n=e("underscore"),r=e("backbone"),i=e("modules/classnames"),s=e("md5");return r.View.extend({startX:0,startY:0,startScale:1,rotation:0,getSignature:function(){return this.signature||(this.signature=s(this.el.innerHTML))},lockSignature:function(){this.getSignature()},disable:function(){this.isDisabled=!0,this.$el.addClass(i.IS_DISABLED)},enable:function(){this.isDisabled=!1,this.$el.removeClass(i.IS_DISABLED)},isInDOM:function(){return this.el.parentNode!==null},startTransform:function(e){e.preventDefault(),e.stopPropagation(),this.startX=e.pageX,this.startY=e.pageY,this.startScale=e.scale,this.startRotation=e.rotation,e.currentTarget.classList.add("alf-is-moving")},transformEventTarget:function(e){this.transformElByEvent(e.currentTarget,e)},transformEl:function(e){this.transformElByEvent(this.el,e)},transformElByEvent:function(e,t){t.preventDefault(),t.stopPropagation(),t=t.originalEvent||t;var n=t.pageX-this.startX,r=t.pageY-this.startY,i=t.scale,s=t.rotation-this.startRotation;this.doTransform(e,{x:n,y:r,scale:i,rotation:s})},doTransform:function(e,t){var n="";n+="translate3d("+t.x+"px, "+t.y+"px, 1px)",t.rotation&&(n+="rotate("+t.rotation+"deg) "),n+="scale("+t.scale+") ",e.style.webkitTransition="none",e.style.webkitTransform=n},enableScrolling:function(e){e=e||{x:!0,y:!0};var t=[];e.x&&t.push("alf-is-scrollable-x"),e.y&&t.push("alf-is-scrollable-y"),this.$el.addClass(t.join(" "))},preventDefault:function(e){e.preventDefault()}})}),function(e,t){var n=function(){this.running=!1,this.tasks=[],this._dispatchNextTask=this._dispatchNextTask.bind(this)};n.prototype={dispatch:function(){if(this.running)return;this._dispatchNextTask()},add:function(e,t){this.tasks.push(e),t||this.dispatch()},_dispatchNextTask:function(){if(!this.tasks[0]){this.running=!1;return}this.running=!0,this.tasks.shift()(this._dispatchNextTask)}},typeof define=="function"&&typeof define.amd=="object"&&define.amd?define("vendor/queue",[],function(){return n}):e.Queue=n}(this),define("modules/util",["require","underscore"],function(e){function r(e){return function(){console[e].apply(console,[].slice.call(arguments))}}var t=e("underscore"),n={touchScreen:"ontouchstart"in window,getRandomInt:function(e,t){return Math.floor(Math.random()*(t-e+1))+e},getVendorPrefix:t.memoize(function(e){var r,i=["","webkit","moz","ms"];return e=n.camelize(e),t.find(i,function(t){return document.body.style[t+e]!==undefined})}),prefixStyle:function(e,t){var r=n.getVendorPrefix(e);return t?r+n.camelize(e):"-"+r+"-"+e},camelize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},matchMedia:window.matchMedia&&t.bind(window.matchMedia,window)};return n.dom={getFieldMap:function(e){var t=e.getAttribute("data-map");return t?t.split(" "):[]},getMediaQuery:function(e){return e.getAttribute("data-media")}},window.console||(window.console={}),window.console.log||t.each(["log","warning","error","info"],function(e){window.console[e]=function(){return{}}}),n.console={log:r("log"),warn:r("warn"),error:r("error"),info:r("info"),debug:r("debug"),groupCollapsed:r("groupCollapsed"),group:r("group"),groupEnd:r("groupEnd")},n}),define("modules/transition/Dispatcher",["require","modules/Base","backbone","underscore","modules/dom","modules/util"],function(e){var t=e("modules/Base"),n=e("backbone"),r=e("underscore"),i=e("modules/dom"),s=e("modules/util"),o=Math,u=t.extend();return r.extend(u.prototype,n.Events,{initialize:function(e){e=this.options=r.extend({},e||{}),r.bindAll(this,"stopRunning"),this.isReset=!1,this._isRunning=!1,this._isReversible=!1,e.target&&this.setTarget(e.target),e.to&&this.setTo(e.to)},setTarget:function(e){this.target=r.defaults(e,{el:null,width:null,height:null,top:null,left:null}),this.calcMetrics()},setTargetEl:function(e){this.setTarget({el:e})},setTo:function(e){this.to=r.defaults(e,{el:null,width:null,height:null})},isRunning:function(){return this._isRunning},stopRunning:function(){this._isRunning=!1},calcMetrics:function(){var e,t,n,s;e=this.target,t=this.to,n=i(e.el),s=i(t.el),e=r.extend(e,e.el.getBoundingClientRect()),t=r.extend(t,{width:t.el.clientWidth,height:t.el.clientHeight}),t.scaleX=e.width/t.width,t.scaleY=e.height/t.height,t.scale=o.max(t.scaleX,t.scaleY),e.scaleX=t.width/e.width,e.scaleY=t.height/e.height,e.scale=o.min(e.scaleX,e.scaleY),this.offsetX=o.round(e.left+(e.width-t.width)/2),this.offsetY=o.round(e.top+(e.height-t.height)/2),t.maskHeight=o.round(e.height/t.scale),t.maskWidth=o.round(e.width/t.scale),t.clipHeight=t.height-t.maskHeight,t.clipWidth=t.width-t.maskWidth},reset:function(){var e=this.to,t=this.options.effect.animateFromProps.call(this);e.el.style.webkitTransitionDuration="0ms",e.el.style.mozTransitionDuration="0ms",e.el.style.msTransitionDuration="0ms",e.el.style.oTransitionDuration="0ms",e.el.style.transitionDuration="0ms";for(var n in t){if(n.toLowerCase().indexOf("transition")!==-1)continue;e.el.style[n]=t[n]}},run:function(e){if(this._isRunning)return!1;this._isRunning=!0,this._isReversible=!0;var t=this,n=this.target,s=this.to,o=function(){t._animate(e)};if(!this.options.upscaleTarget||!n||!n.el){this.trigger("willAppear",this,o);return}n.el.classList.add("alf-is-moving");var u="",a=s.width/2-n.width/2-n.left,f=s.height/2-n.height/2-n.top;u+="translate3d("+a+"px, "+f+"px, 1px) ",u+="scale("+n.scale+") ",i(n.el).one("webkitTransitionEnd",r.bind(this._onScaleEnd,this,e)),i(n.el).one("transitionend",r.bind(this._onScaleEnd,this,e)),n.el.style.webkitTransition="-webkit-transform ease-out 300ms",n.el.style.transition="transform ease-out 300ms",n.el.style.webkitTransform=u,n.el.style.transform=u},reverse:function(e){var t=this.options.effect;if(this._isRunning||!this._isReversible)return!1;this._isRunning=!0;var n=this.to,s=(t.reverseProps||t.animateFromProps).call(this);i(n.el).one("webkitTransitionEnd",r.bind(this._onReverseEnd,this,e)),i(n.el).one("transitionend",r.bind(this._onReverseEnd,this,e));for(var o in s)n.el.style[o]=s[o]},reverseTo:function(e,t){this.to={el:e},this.calcMetrics(),this.reverse(t)},_animate:function(e){var t=this.to,n=this.options.effect.animateToProps.call(this);this.reset(),this.trigger("ready",this),i(t.el).one("webkitTransitionEnd",r.bind(this._onAnimateEnd,this,e)),i(t.el).one("transitionend",r.bind(this._onAnimateEnd,this,e)),r.each(n,function(e,n){t.el.style[n]=e})},_onAnimateEnd:function(e){var t;this.to&&this.to.el&&(this.to.el.style.removeProperty("-webkit-transition"),this.to.el.style.removeProperty("transition")),this.target&&this.target.el&&(t=this.target.el.style,t.removeProperty("-webkit-transform"),t.removeProperty("-webkit-transition"),t.removeProperty("transform"),t.removeProperty("transition"),i(this.target.el).removeClass("alf-is-moving")),e&&e.call(this,this),this.trigger("didAppear",this),setTimeout(this.stopRunning,100)},_onReverseEnd:function(e){this._isReversible=!1,this.to.el.style.webkitTransition="none",this.to.el.style.webkitTransform="none",this.to.el.style.mozTransition="none",this.to.el.style.mozTransform="none",this.to.el.style.msTransition="none",this.to.el.style.msTransform="none",this.to.el.style.oTransition="none",this.to.el.style.oTransform="none",this.to.el.style.transition="none",this.to.el.style.transform="none",e&&e.call(this,this),this.trigger("didDisappear",this),setTimeout(this.stopRunning,100)},_onScaleEnd:function(e){var t=this,n=function(){t._animate(e)};this.trigger("willAppear",this,n)}}),u}),define("modules/transition/Appear",["require"],function(e){var t={reverseProps:function(){return{webkitTransition:"-webkit-transform ease-out 300ms",webkitTransform:"translate3d(-1500px, -1500px, 0) scale(0.4)"}},animateFromProps:function(){var e="";return e+="scaleX(0.8) scaleY(0.8) ",{webkitTransition:"-webkit-transform ease-out 300ms, opacity ease-out 300ms",webkitTransform:e,opacity:0}},animateToProps:function(){var e=this.to;return{webkitTransition:"-webkit-transform ease-out 300ms, opacity ease-out 300ms",webkitTransform:"translate3d(0, 0, 0) scaleX(1) scaleY(1)",opacity:1}}};return t}),define("modules/transition/Clip",["require"],function(e){var t=Math,n={animateFromProps:function(){var e="",n=this.to,r=t.round(this.clipHeight/2),i=n.height-r,s=t.round(this.clipWidth/2),o=n.width-s;return e+="translate3d("+this.offsetX+"px, "+this.offsetY+"px, 0px) ",e+="scale("+this.to.scale+") ",{webkitTransition:"-webkit-transform ease-out 300ms, clip ease-out 300ms",webkitTransform:e,clip:"rect("+r+"px, "+o+"px, "+i+"px, "+s+"px) "}},animateToProps:function(){var e=this.to;return{webkitTransition:"-webkit-transform ease-out 300ms, clip ease-out 300ms",webkitTransform:"translate3d(0, 0, 0) scaleX(1) scaleY(1)",clip:"rect(0px, "+e.width+"px, "+e.height+"px, 0px)"}}};return n}),define("modules/transition/Fade",["require"],function(e){var t={animateFromProps:function(){return{webkitTransition:"opacity ease-out 300ms",mozTransition:"opacity ease-out 300ms",msTransition:"opacity ease-out 300ms",oTransition:"opacity ease-out 300ms",transition:"opacity ease-out 300ms",opacity:0}},animateToProps:function(){return{webkitTransition:"opacity ease-out 300ms",mozTransition:"opacity ease-out 300ms",msTransition:"opacity ease-out 300ms",oTransition:"opacity ease-out 300ms",transition:"opacity ease-out 300ms",opacity:1}}};return t}),define("modules/transition/Scale",["require"],function(e){var t={animateFromProps:function(){var e="";return e+="translate3d("+this.offsetX+"px, "+this.offsetY+"px, 0px) ",e+="scaleX("+this.scaleX+") scaleY("+this.scaleY+") ",{webkitTransition:"-webkit-transform ease-out 300ms, opacity ease-out 200ms",webkitTransform:e,opacity:0}},animateToProps:function(){var e=this.to;return{webkitTransition:"-webkit-transform ease-out 300ms, opacity ease-out 200ms",webkitTransform:"translate3d(0, 0, 0) scaleX(1) scaleY(1)",opacity:1}}};return t}),define("modules/transition",["require","modules/transition/Dispatcher","modules/transition/Appear","modules/transition/Clip","modules/transition/Fade","modules/transition/Scale"],function(e){return{Dispatcher:e("modules/transition/Dispatcher"),Appear:e("modules/transition/Appear"),Clip:e("modules/transition/Clip"),Fade:e("modules/transition/Fade"),Scale:e("modules/transition/Scale")}}),define("modules/layer/Manager",["require","modules/Base"],function(e){var t=e("modules/Base");return t.extend({initialize:function(){this.layers=[],this.length=0},add:function(e){return this.layers.push(e),this.length=this.layers.length,this},remove:function(e){var t=this.layers;return t.splice(t.indexOf(e),1),this.length=this.layers.length,this},at:function(e){return this.layers[e]},getPos:function(e){return this.layers.indexOf(e)},getLayerAbove:function(e){return this.at(this.getPos(e)+1)},getLayerBelow:function(e){return this.at(this.getPos(e)-1)}})}),define("modules/layer/View",["require","underscore","modules/BaseView","modules/transition","modules/classnames"],function(e){var t=e("underscore"),n=e("modules/BaseView"),r=e("modules/transition"),i=e("modules/classnames"),s=n.extend();t.extend(s.prototype,{initialize:function(e){e&&e.manager&&(this.manager=e.manager,this.manager.add(this))},tearDown:function(){this.stopListening()},show:function(){return this.$el.removeClass(i.IS_HIDDEN),this},hide:function(){return this.$el.addClass(i.IS_HIDDEN),this},above:function(){return this.manager.getLayerAbove(this)},below:function(){return this.manager.getLayerBelow(this)},minimize:function(){var e=this,t=this.below();return t.show(),t.transition.reverse(function(){e.hide()}),this},transitionTo:function(e,t,n){return this._createTransition({layer:e,target:n,effect:t,upscaleTarget:!1})},scaleTo:function(e,t,n){return this._createTransition({layer:e,target:n,effect:t,upscaleTarget:!0})},transitionToLayerAbove:function(e,t){return this.transitionTo(this.above(),e,t)},transitionToLayerBelow:function(e,t){return this.transitionTo(this.below(),t,e)},_createTransition:function(e){e.to={el:e.layer.el};var t=new r.Dispatcher(e);return this.listenTo(t,"didDisappear",function(n){e.layer.$el.addClass(i.IS_HIDDEN)}),this.listenTo(t,"ready",function(){e.layer.$el.removeClass(i.IS_HIDDEN)}),t}});var o=s.prototype;return o.getLayerBelow=o.below,o.getLayerAbove=o.above,s}),define("modules/layer/Page",["require","modules/dom","underscore","modules/layer/View","modules/transition"],function(e){var t=e("modules/dom"),n=e("underscore"),r=e("modules/layer/View"),i=e("modules/transition"),s=r.extend();return n.extend(s.prototype,{render:function(){return this}}),s}),define("modules/layer/Fullscreen",["require","underscore","modules/dom","modules/layer/View","modules/classnames","modules/util","modules/hub"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("modules/layer/View"),i=e("modules/classnames"),s=e("modules/util"),o=e("modules/hub"),u=r.extend();return t.extend(u.prototype,{fullscreenEvents:{touch:{touchstart:"_onTouchStart",singleTap:"toggleControls","tap .alf-fullscreen-exit":"exitFullscreen",doubleTap:"exitFullscreen",touchend:"preventDefault"},pointer:{mouseover:"showControls",mouseout:"hideControls","click .alf-fullscreen-exit":"exitFullscreen",dblclick:"exitFullscreen"}},initialize:function(e){e=this.options=t.extend({},e||{}),t.bindAll(this,"_onScroll"),u.__super__.initialize.apply(this,t.toArray(arguments)),this.position=this.$el.css("position"),this.listenTo(o,"fullscreenWillAppear",this._fullscreenWillAppear),e.resizeToWindow=e.resizeToWindow===undefined?!0:e.resizeToWindow,this.delegateEvents(s.touchScreen?this.fullscreenEvents.touch:this.fullscreenEvents.pointer)},tearDown:function(){this.stopListening(),this.$el.empty()},render:function(){return this},renderFullscreenContainer:function(e){var t,r,s=new RegExp("\\s?"+i.REVISION("")+"[^\\s]*");return this.el.className=this.el.className.replace(s,""),r=n("<div>").addClass(i.BTN_GROUP),r.append(n("<button>").addClass(i.FULLSCREEN_EXIT)),this.$toolbar=n("<div>").addClass(i.FULLSCREEN_TOOLBAR),this.$toolbar.append(r),this.$content=n("<div>").addClass(i.FULLSCREEN_CONTENT),this.$content.append(e.el),t=document.createDocumentFragment(),t.appendChild(this.$toolbar[0]),t.appendChild(this.$content[0]),this.$el.empty().removeClass(i.CONTROLS_OFF).addClass(i.REVISION(e.options.revision)).append(t),!this.options.resizeToWindow&&!this.metrics&&this._calculateMetrics(),this},toggleControls:function(){this.$el.toggleClass(i.CONTROLS_OFF)},showControls:function(){this.$el.removeClass(i.CONTROLS_OFF)},hideControls:function(){this.$el.addClass(i.CONTROLS_OFF)},exitFullscreen:function(e){e&&(e.stopPropagation(),e.preventDefault());var t=this.below();if(this.gestureStarted||t.transition.isRunning())return!1;n(window).off("mousewheel",this._onMouseWheelScroll).off("scroll touchmove touchend",this._onScroll),t.transition.reverse(),o.trigger("fullscreenWillDisappear")},_calculateMetrics:function(){this._windowHeight=window.innerHeight,this._windowWidth=window.innerWidth,this.metrics=this.$el.metrics()},_onTouchStart:function(e){var t=n(e.target),r;r=t.css("overflow");if(r==="scroll"||r==="auto")return;e.preventDefault()},_onGestureStart:function(e){if(this.gestureStarted||this.below().transition.isRunning())return!1;this.gestureStarted=!0,this.startTransform(e)},_onGestureChange:function(e){if(this.below().transition.isRunning())return!1;this.transformEventTarget(e)},_onGestureEnd:function(e){var t=this.below();if(t.transition.isRunning())return!1;t.transition.reverse(),this.gestureStarted=!1},_fullscreenWillAppear:function(e){var t,r,i,o;i={},this.options.resizeToWindow&&(i.width=window.innerWidth+"px",i.height=window.innerHeight+"px");if(this.position!=="fixed"){this.x=window.pageXOffset,this.y=window.pageYOffset;var u="translate("+this.x+"px, "+this.y+"px)";i[s.prefixStyle("transform")]=u,i.transform=u}this.$el.css(i),n(window).on("mousewheel",this._onMouseWheelScroll).on("scroll touchmove touchend",this._onScroll)},_onMouseWheelScroll:function(e){e.preventDefault()},_onScroll:function(e){if(this.position==="fixed"||this.y===window.pageYOffset&&this.x===window.pageXOffset)return;this.y=window.pageYOffset,this.x=window.pageXOffset;var t="translate("+this.x+"px, "+this.y+"px)",n={transform:t};n[s.prefixStyle("transform")]=t,this.$el.css(n)}}),u}),define("modules/layer",["require","modules/layer/Manager","modules/layer/View","modules/layer/Page","modules/layer/Fullscreen"],function(e){return{Manager:e("modules/layer/Manager"),View:e("modules/layer/View"),Page:e("modules/layer/Page"),Fullscreen:e("modules/layer/Fullscreen")}}),define("modules/layout/WidgetList",["require","modules/Base","underscore"],function(e){var t=e("modules/Base"),n=e("underscore"),r=t.extend({initialize:function(e){this.widgets=[],n.isPlainObject(e)&&n.each(e,function(e,t){this.add(e,t)},this)},add:function(e,t){this.widgets.push(this.normalize(e,t))},normalize:function(e,t){typeof e=="function"&&(e={run:e}),n.defaults(e,{compile:!1,render:function(){},run:function(e){e()},fullscreen:function(e,t){t()},selector:t});if(!e.selector)throw new Error("Failed to normalize widget. No selector found!");return e},getMatchesForContainer:function(e){var t=[];return this.each(function(n){var r=e.$el.is(n.selector)?e.$el:e.$el.find(n.selector);r.length&&t.push({container:e,widget:n,$el:r,el:r[0]})},this),t}});return n.each(["each","map","isEmpty","filter"],function(e){r.prototype[e]=function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this.widgets),n[e].apply(n,t)}}),r}),define("vendor/swiper",["require"],function(e){var t=5,n=["_onMove","_onMoveStart","_onMoveEnd","_onMoveStartCapture","_onMoveCapture","_onMoveEndCapture","_onTransitionEnd","_onKeyPress","_refresh","_renderPages"],r=Array.prototype.slice,i=function(e,t,n){return r.call(e).forEach(t,n)},s=function(e,t){var r=this,s=e.children[0];n.forEach(function(e){r[e]=r[e].bind(r)}),this.el=e,this.elements={pageContainer:s,pages:[],scrollablePages:[]},i(s.children,function(e,t){this.elements.pages.push({el:e,offset:t*100,pageNum:t}),e.classList.contains("is-scrollable")&&this.elements.scrollablePages.push(e)},this),this.concurrentPages=this.elements.pages.length,t=t||{},t.overflowScrolling=t.overflowScrolling||!1,t.renderDeferTime=t.renderDeferTime||200,t.scrollDuration=t.scrollDuration||320,t.tapToFlip=t.tapToFlip||!1,t.loadingClass=t.loadingClass||"swiper-page-is-loading",t.enableKeyNavigation=t.enableKeyNavigation===undefined?!0:t.enableKeyNavigation,this.options=t,this.events={},this.renderTimeout=null,this.pageFlipWidth=50,this.x=0,this.currentPage=0};return s.prototype={start:function(){this.pageWidth=this.elements.pages[0].el.clientWidth,this.windowWidth=window.innerWidth,this._renderPages(),this.enable()},gotoPage:function(e,t,n){var r=this,i,s,o=this.x||0,u=0;t=t!==undefined?t:this.options.scrollDuration,n=t===0?!1:n,e=parseInt(e,10),clearTimeout(this.renderTimeout),e<0||isNaN(e)||this.options.numberOfPages===0?e=0:e>this.options.numberOfPages-1&&(e=this.options.numberOfPages-1),this.prevPage=this.currentPage,this.currentPage=e,e>0&&e<this.options.numberOfPages-1&&this._positionPages(),this.x=e*this.pageWidth*-1,this._moveX(this.elements.pageContainer,this.x+"px",t),(!n||o===this.x)&&this._onPageChange(!0);if(this.prevPage===this.currentPage)return;i=this.elements.pages[e%this.concurrentPages],r.trigger("pageWillAppear",i.el.children[1],e),s=this.elements.pages[this.prevPage%this.concurrentPages],r.trigger("pageWillDisappear",s.el.children[1],this.prevPage)},on:function(e,t,n){var r=this.events[e]||(this.events[e]=[]);r.push({callback:t,context:n||this})},trigger:function(e){var t=this.events[e],n;if(!t)return;n=r.call(arguments,1);for(var i in t)t[i].callback.apply(t[i].context,n)},enable:function(){var e=this.elements.pageContainer;this._disableOverflowScrolling(),e.addEventListener("touchstart",this._onMoveStartCapture,!0),e.addEventListener("webkitTransitionEnd",this._onTransitionEnd,!0),e.addEventListener("transitionend",this._onTransitionEnd,!0),window.addEventListener("keydown",this._onKeyPress,!1),window.addEventListener("resize",this._refresh,!0)},disable:function(){this._enableOverflowScrolling(),this.elements.pageContainer.addEventListener("touchstart",this._onMoveStartCapture,!0),window.removeEventListener("keydown",this._onKeyPress,!1),window.removeEventListener("resize",this._refresh,!0)},gotoCurrentPage:function(e){this.gotoPage(this.currentPage,e)},gotoPrevPage:function(){this.gotoPage(this.currentPage-1,this.options.scrollDuration)},gotoNextPage:function(){this.gotoPage(this.currentPage+1,this.options.scrollDuration)},refresh:function(e){i(this.elements.pages,function(e){e.prevPage=undefined}),e=e||{};for(var t in e)this.options[t]=e[t];this.trigger("refresh"),this.gotoPage(this.currentPage,undefined,!1)},reset:function(e){this.prevPage=undefined,i(this.elements.pages,function(e){e.prevPage=e.prevPage===undefined?undefined:null,e.pageNum=null}),e=e||{};for(var t in e)this.options[t]=e[t];this.trigger("refresh"),this.gotoPage(0,0,!1)},_positionPages:function(){var e=this,t=this.currentPage,n=[],r=(this.concurrentPages-1)/2,i=t-r,s=t+r;i=i<0?0:i,s=s<this.options.numberOfPages?s:this.options.numberOfPages-1;for(var o=i;o<=s;o++){var u=this.elements.pages[o%this.concurrentPages],a=o*100,f=u.el.children[0];u.prevOffset=u.offset===undefined?a:u.offset,u.offset=a,u.prevOffset!==u.offset&&(f.classList.add(e.options.loadingClass),this._moveX(u.el,u.offset+"%"))}},_renderPage:function(e,t){var n=e.el.children[1],r=e.prevPage===undefined;e.prevPage=e.pageNum,e.pageNum=t;if(r||e.prevPage!==e.pageNum)n.scrollTop=0,n.scrollLeft=0,r||this.trigger("pageWillDestruct",n,e.prevPage),this.trigger("pageWillRender",n,t);e.el.children[0].classList.remove(this.options.loadingClass)},_renderPages:function(){var e=this,t,n,r=this.currentPage,i=r,s=this.options,o=this.elements.pages,u=r<=this.prevPage?1:-1;for(var a=0;a<this.concurrentPages;a++){i+=a*u,u*=-1,t=o[i%this.concurrentPages];if(!t||i>s.numberOfPages-1)continue;e._renderPage(t,i)}e.trigger("pageDidAppear",o[r%this.concurrentPages].el.children[1],r),n=o[this.prevPage%this.concurrentPages],n&&e.trigger("pageDidDisappear",n.el.children[1],this.prevPage)},_refresh:function(e){this.pageWidth=this.elements.pages[0].el.clientWidth,this.windowWidth=window.innerWidth,this.gotoCurrentPage()},_onKeyPress:function(e){if(!this.options.enableKeyNavigation)return;switch(e.keyCode){case 37:this.gotoPrevPage();break;case 39:this.gotoNextPage()}},_onMoveStartCapture:function(e){var t=this.elements.pageContainer;this.moved=!1,this.pointX=e.touches[0].pageX,this.pointY=e.touches[0].pageY,this.deltaX=0,this.deltaY=0,this.distX=0,this.distY=0,this.directionCalc=!1,this.multitouch=e.touches.length>1,this.multitouch?(this._disableOverflowScrolling(),t.removeEventListener("touchmove",this._onMoveCapture,!0),t.removeEventListener("touchend",this._onMoveEndCapture,!0)):(t.addEventListener("touchmove",this._onMoveCapture,!0),t.addEventListener("touchend",this._onMoveEndCapture,!0)),t.addEventListener("touchstart",this._onMoveStart,!1)},_onMoveCapture:function(e){var t=this.elements.pageContainer,n=e.touches[0].pageX,r=e.touches[0].pageY;if(this.multitouch)return;this.deltaX=n-this.pointX,this.deltaY=r-this.pointY,this.pointX=n,this.pointY=r;if(this.directionCalc)return;this.distX<4&&this.distY<4&&(this.distX+=Math.abs(this.deltaX),this.distY+=Math.abs(this.deltaY),this.directionCalc=!0),this.distY<2||this.distX>this.distY+5?(this._disableOverflowScrolling(),t.addEventListener("touchmove",this._onMove,!1),t.addEventListener("touchend",this._onMoveEnd,!1)):(this.distX<2||this.distY>this.distX+5)&&this._enableOverflowScrolling()},_onMoveEndCapture:function(e){this.elements.pageContainer.removeEventListener("touchstart",this._onMoveStart,!1),this._disableOverflowScrolling();if(this.options.tapToFlip&&!this.moved){if(this.pointX<this.pageFlipWidth){this.gotoPrevPage();return}if(this.pointX>this.windowWidth-this.pageFlipWidth){this.gotoNextPage();return}}},_onMoveStart:function(e){this.startX=e.touches[0].pageX,this.startY=e.touches[0].pageY},_onMove:function(e){e.preventDefault(),clearTimeout(this.renderTimeout),this.moved=!0;if(this.x>0||this.currentPage===this.options.numberOfPages-1&&this.x<0)this.deltaX*=.5;this.x+=this.deltaX,this._moveX(this.elements.pageContainer,Math.round(this.x)+"px",0)},_onMoveEnd:function(){var e=this.elements.pageContainer,n=this.startX-this.pointX,r=Math.abs(n),i=Math.abs(this.deltaX),s=this.pageWidth/2,o=this.options.scrollDuration;this.elements.pageContainer.style.webkitTransitionDuration=o+"ms",this.elements.pageContainer.style.MozTransitionDuration=o+"ms",e.removeEventListener("touchmove",this._onMove,!1),e.removeEventListener("touchend",this._onMoveEnd,!1),this._disableOverflowScrolling(),r<s&&i<t?this.gotoCurrentPage():n>0?this.gotoNextPage():this.gotoPrevPage()},_moveX:function(e,t,n){n!==undefined&&(e.style.webkitTransitionDuration=n+"ms",e.style.MozTransitionDuration=n+"ms"),e.style.webkitTransform="translate3d("+t+", 0, 0)",e.style.MozTransform="translate("+t+", 0)"},_onPageChange:function(e){e?this._renderPages():this.renderTimeout=setTimeout(this._renderPages,this.options.renderDeferTime)},_onTransitionEnd:function(e){if(e.propertyName.indexOf("transform")===-1)return;this._onPageChange()},_preventDefaultEvent:function(e){e.preventDefault()},_disableOverflowScrolling:function(){if(!this.options.overflowScrolling)return;var e=this;i(this.elements.scrollablePages,function(t){t.addEventListener("touchmove",e._preventDefaultEvent,!0)})},_enableOverflowScrolling:function(){if(!this.options.overflowScrolling)return;var e=this;i(this.elements.scrollablePages,function(t){t.removeEventListener("touchmove",e._preventDefaultEvent,!0)})}},s.prototype.destroy=s.prototype.disable,s}),Function.prototype.bind||(Function.prototype.bind=function(e){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},i=function(){return n.apply(this instanceof r?this:e||window,t.concat(Array.prototype.slice.call(arguments)))};return r.prototype=this.prototype,i.prototype=new r,i}),define("modules/nav/ScrollView",["require","vendor/swiper"],function(e){return e("vendor/swiper")}),define("modules/layout/widgets/inline",["require","modules/dom","underscore","modules/util","modules/nav/ScrollView"],function(e){function s(e,n){var r=t('<div class="alf-slideshow-nav">'),i=t('<a class="alf-slideshow-nav-next"></a>'),s=t('<a class="alf-slideshow-nav-prev"></a>');r.append(s).append(i),e.append(r),s.on("dblclick",!1),i.on("dblclick",!1),s.on("click",function(){return n.gotoPrevPage(),!1}),i.on("click",function(){return n.gotoNextPage(),!1});var o=n.options.numberOfPages;s.addClass("alf-is-hidden"),n.on("pageWillAppear",function(e,t){t===0?s.addClass("alf-is-hidden"):t>0&&t<o-1?(s.removeClass("alf-is-hidden"),i.removeClass("alf-is-hidden")):t===o-1&&i.addClass("alf-is-hidden")})}var t=e("modules/dom"),n=e("underscore"),r=e("modules/util"),i=e("modules/nav/ScrollView");return{".alf-slideshow":{compile:!0,render:function(){var e,n,r;e=t("<div>").css({position:"relative",top:0,left:0}),n=t("<div>").addClass("alf-slideshow-toggle alf-fullscreen-toggle alf-is-draggable"),this.$el.children(":not(:first-child)").remove(),e.append(n).append(this.$el),r=t("<div>").addClass("alf-slideshow-stack"),this.$el.addClass("alf-slideshow-inline").prepend(r.clone().addClass("alf-slideshow-stack-1")).prepend(r.clone().addClass("alf-slideshow-stack-2")),this.container.$el.append(e)},run:function(e){var t=this.container.$el.find(".alf-slideshow-toggle");t.length&&t.css("display")!=="none"&&this.container.preventDefaultEvents(),this.container.$el.on(r.touchScreen?"tap":"click",".alf-fullscreen-toggle",this.container.enterFullscreen).on("touchend",".alf-fullscreen-toggle",function(e){e.preventDefault()}),e()},fullscreen:function(e,n){var o,u,a,f;a=e.$el.find(".alf-slideshow").children().clone(),f=a.length,u=t('<button class="alf-slideshow-progress"></button>'),u.text("1/"+f),e.layer.$toolbar.append(u),o=t('<div class="alf-slideshow"><div class="alf-pages"><div class="alf-page alf-page-1"><section class="alf-page-loader swiper-page-is-loading"></section><section class="alf-page-content"></section></div><div class="alf-page alf-page-2"><section class="alf-page-loader swiper-page-is-loading"></section><section class="alf-page-content"></section></div><div class="alf-page alf-page-3"><section class="alf-page-loader swiper-page-is-loading"></section><section class="alf-page-content"></section></div></div></div>'),e.$el.empty().append(o);var l=new i(o[0],{numberOfPages:a.length,enableKeyNavigation:!0});l.on("pageWillRender",function(e,n){t(e).empty().append(a[n])}),l.on("pageWillAppear",function(e,t){u.text(t+1+"/"+f)}),l.start(),r.touchScreen||s(e.layer.$content,l),n()}},".alf-stretch-to-fit h1":{compile:!0,render:function(){this.$el.textFit()}}}}),define("modules/layout/mixins/Widgetable",["require","underscore","modules/layout/WidgetList","modules/layout/widgets/inline"],function(e){var t=e("underscore"),n=e("modules/layout/WidgetList"),r=e("modules/layout/widgets/inline");return{setupWidgets:function(e){var i;this.widgets=e.widgets,e.widgets instanceof n||(this.widgets=new n(r),i=t.isArray(e.widgets),t.each(e.widgets,function(e,t){this.widgets.add(e,i?undefined:t)},this))}}}),define("modules/layout/mixins/LayoutElement",["require","modules/dom","underscore","modules/classnames","modules/util"],function(e){function s(e){return n.isArray(e)?e:i.dom.getFieldMap(e.el)}var t=e("modules/dom"),n=e("underscore"),r=e("modules/classnames"),i=e("modules/util"),o={isInline:!1,defaultMetrics:function(e){this.metrics=n.extend({height:0,width:0,outerHeight:0,lineHeight:24,marginTop:0,marginRight:0,marginBottom:0,marginLeft:0,marginHeight:0,marginWidth:0},this.metrics||{},e||{})},setMetrics:function(e){this.metrics=n.extend(this.metrics||{},e)},calculateMetrics:function(){if(!this.el.children.length){this.metrics=this.$el.metrics();return}var e=parseInt(window.getComputedStyle(this.el).getPropertyValue("border-bottom-width"),10);if(e){this.metrics=this.$el.metrics();return}this.isInline||(this.el.style.borderBottom="1px solid transparent"),this.metrics=this.$el.metrics(),this.isInline||(this.el.style.removeProperty("border-bottom"),this.metrics.outerHeight-=1)},lockSize:function(){var e=this.metrics;this.$el.css({height:e.height+"px",width:e.width+"px"})},isTextElement:function(){return["P","H1","H2","H3","H4","H5","H6","HEADER","SPAN"].indexOf(this.el.tagName)!==-1},normalize:function(e,t){if(this._isNormalized)return;var i={},s=this.$el.hasClass(r.CONTAINER),o=this.metrics,u=0;this._normalizeTopMargin(i),t=t||0;var a=Math.min(t,o.marginTop);e=e||o.lineHeight,u=(o.outerHeight-a)%e,u!==0&&!s&&(u=e-u,o.marginBottom+=u,o.marginHeight+=u,o.outerHeight+=u,i["margin-bottom"]=o.marginBottom+"px"),this._isNormalized=!0,n.isEmpty(i)||this.$el.css(i)},_normalizeTopMargin:function(e){var t=this.metrics;t.marginTop>0&&this.isTextElement()&&(t.outerHeight-=t.marginTop,t.marginHeight-=t.marginTop,t.marginTop=0,e["margin-top"]=0)}};return o}),define("modules/BaseModel",["require","backbone"],function(e){var t=e("backbone");return t.Model.extend({})}),define("modules/layout/Format",["require","modules/BaseModel"],function(e){var t=e("modules/BaseModel"),n=t.extend({defaults:{title:"",name:"",width:0,height:0},initializeFromWindow:function(){return this.set({width:window.innerWidth,height:window.innerHeight,name:"window",title:"Window"}),this}});return n}),define("modules/layout/FigureElement",["require","modules/BaseView","modules/classnames","modules/util"],function(e){var t=e("modules/BaseView"),n=e("modules/classnames"),r=e("modules/util"),i=t.extend({setElement:function(e){i.__super__.setElement.call(this,e),this.noScore=this.$el.hasClass(n.NO_SCORE),this.fieldMap=r.dom.getFieldMap(this.el)}});return i}),define("modules/layout/Figure",["require","underscore","modules/BaseView","modules/util","modules/classnames","modules/layout/FigureElement"],function(e){function o(e){return t.map(e,f)}function u(e){if(e.indexOf("*")===-1)return new RegExp("^"+e+"$");var t=e.replace(/([\-\:])/g,"\\$1");return t=t.replace(/(^|[^\\W\*])\*(\\|$)/g,"$1[^\\W]+$2"),t=t.replace(/(^|[^\\W])\*\*(\\|$)/g,"$1(.*)?$2"),new RegExp("^"+t+"$")}function a(e,n){return t.find(n,function(t){return t.match(e)})}var t=e("underscore"),n=e("modules/BaseView"),r=e("modules/util"),i=e("modules/classnames"),s=e("modules/layout/FigureElement"),f=t.memoize(u),l=t.memoize(a,function(e,t){return[e,t]}),c=n.extend({initialize:function(){this.elements=this.$el.children().map(function(){var e=new s({el:this,figure:this});return e.lockSignature(),e})},setElement:function(e){c.__super__.setElement.call(this,e),this.isOptional=this.$el.hasClass(i.IS_OPTIONAL)},getElementMappedToField:function(e){var n=null;return t.each(o(e),function(e){n=t.find(this.elements,function(t){return l(e,t.fieldMap)});if(n)return!1},this),n}});return c}),define("when",[],function(){function r(e,t,n,r){return i(e).then(t,n,r)}function i(e){var t,n;return e instanceof o?t=e:l(e)?(n=f(),e.then(function(e){n.resolve(e)},function(e){n.reject(e)},function(e){n.progress(e)}),t=n.promise):t=u(e),t}function s(e){return r(e,a)}function o(e){this.then=e}function u(e){var t=new o(function(t){try{return i(t?t(e):e)}catch(n){return a(n)}});return t}function a(e){var t=new o(function(t,n){try{return n?i(n(e)):a(e)}catch(r){return a(r)}});return t}function f(){function h(e,t,n){return u(e,t,n)}function p(e){return c(e)}function d(e){return c(a(e))}function v(e){return l(e)}var e,t,r,s,u,l,c;return t=new o(h),e={then:h,resolve:p,reject:d,progress:v,promise:t,resolver:{resolve:p,reject:d,progress:v}},r=[],s=[],u=function(e,t,n){var i,o;return i=f(),o=typeof n=="function"?function(e){try{i.progress(n(e))}catch(t){i.progress(t)}}:function(e){i.progress(e)},r.push(function(n){n.then(e,t).then(i.resolve,i.reject,o)}),s.push(o),i.promise},l=function(e){return y(s,e),e},c=function(e){return e=i(e),u=e.then,c=i,l=w,y(r,e),s=r=n,e},e}function l(e){return e&&typeof e.then=="function"}function c(e,t,n,i,s){return b(2,arguments),r(e,function(e){function g(e){p(e)}function y(e){h(e)}var o,u,a,l,c,h,p,d,v,m;v=e.length>>>0,o=Math.max(0,Math.min(t,v)),a=[],u=v-o+1,l=[],c=f();if(!o)c.resolve(a);else{d=c.progress,p=function(e){l.push(e),--u||(h=p=w,c.reject(l))},h=function(e){a.push(e),--o||(h=p=w,c.resolve(a))};for(m=0;m<v;++m)m in e&&r(e[m],y,g,d)}return c.then(n,i,s)})}function h(e,t,n,r){function i(e){return t?t(e[0]):e[0]}return c(e,1,i,n,r)}function p(e,t,n,r){return b(1,arguments),v(e,E).then(t,n,r)}function d(){return v(arguments,E)}function v(e,t){return r(e,function(e){var n,i,s,o,u,a;s=i=e.length>>>0,n=[],a=f();if(!s)a.resolve(n);else{o=function(i,o){r(i,t).then(function(e){n[o]=e,--s||a.resolve(n)},a.reject)};for(u=0;u<i;u++)u in e?o(e[u],u):--s}return a.promise})}function m(n,i){var s=t.call(arguments,1);return r(n,function(t){var n;return n=t.length,s[0]=function(e,t,s){return r(e,function(e){return r(t,function(t){return i(e,t,s,n)})})},e.apply(t,s)})}function g(e,t,n){var i=arguments.length>2;return r(e,function(e){return e=i?n:e,t.resolve(e),e},function(e){return t.reject(e),a(e)},t.progress)}function y(e,t){var n,r=0;while(n=e[r++])n(t)}function b(e,t){var n,r=t.length;while(r>e){n=t[--r];if(n!=null&&typeof n!="function")throw new Error("arg "+r+" must be a function")}}function w(){}function E(e){return e}var e,t,n;return r.defer=f,r.resolve=i,r.reject=s,r.join=d,r.all=p,r.map=v,r.reduce=m,r.any=h,r.some=c,r.chain=g,r.isPromise=l,o.prototype={always:function(e,t){return this.then(e,e,t)},otherwise:function(e){return this.then(n,e)},yield:function(e){return this.then(function(){return e})},spread:function(e){return this.then(function(t){return p(t,function(t){return e.apply(n,t)})})}},t=[].slice,e=[].reduce||function(e){var t,n,r,i,s;s=0,t=Object(this),i=t.length>>>0,n=arguments;if(n.length<=1)for(;;){if(s in t){r=t[s++];break}if(++s>=i)throw new TypeError}else r=n[1];for(;s<i;++s)s in t&&(r=e(r,t[s],s,t));return r},r}),define("modules/layout/ContentRetainer",["require","underscore"],function(e){var t=e("underscore"),n={retain:function(e){this.content.retain(e),this.retained=this.retained||[],this.retained.push(e)},releaseAll:function(){if(!this.retained||!this.retained.length)return;this.content.release(this.retained),this.retained=[]},didRetainElements:function(){return!!this.retained&&this.retained.length>0}};return n}),define("modules/layout/Container",["require","underscore","modules/dom","modules/BaseView","modules/transition","modules/layout/mixins/LayoutElement","modules/layout/ContentRetainer","modules/classnames","modules/hub","modules/util","when"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("modules/BaseView"),i=e("modules/transition"),s=e("modules/layout/mixins/LayoutElement"),o=e("modules/layout/ContentRetainer"),u=e("modules/classnames"),a=e("modules/hub"),f=e("modules/util"),l=e("when"),c=r.extend();return c.loadedAssets=[],t.extend(c.prototype,s,o,{fullscreenEvents:{touch:{"touchstart img":"onTouchStart","touchmove img":"onTouchMove","touchend img":"onTouchEnd","tap img":"onTap"},pointer:{"click img":"onTap"}},className:u.CONTAINER,initialize:function(e){e=this.options=t.extend({},e||{}),this.id=this.el.id||this._setUniqueId(),t.bindAll(this,"load","_doLoad","_loadComplete","_loadReady","enterFullscreen"),this.defaultMetrics(),this.deferreds=[],this.loaded=null,this.isDirty=!1,this.isResponsive=!1,e.pixelRatio=parseInt(e.pixelRatio||window.devicePixelRatio||1,10)},tearDown:function(){this.releaseAll(),this.stopListening(),this.undelegateEvents(),this.el=null,this.figureEl=null,this.fullscreenEl&&n(this.fullscreenEl).remove(),this.fullscreenEl=null,this.$el.find("img").each(function(){this.style.removeProperty("max-width"),this.style.removeProperty("max-height"),this.style.removeProperty("width"),this.style.removeProperty("height")})},remove:function(){this.$el.addClass(u.IS_REMOVED),this.isRemoved=!0,this.releaseAll(),this.figure=null,this.figureEl=null,this.$el.empty()},clone:function(){var e;return e=new c({el:this.el.cloneNode(!0)}),e._setUniqueId(),e},setElement:function(e){c.__super__.setElement.call(this,e),this.fieldMap=f.dom.getFieldMap(this.el),this.ref=this.el.dataset.ref,this.isOptional=this.$el.hasClass(u.IS_OPTIONAL),this.isRemoved=this.$el.hasClass(u.IS_REMOVED)},setFigure:function(e,t){return this.figure=e,this.figureEl=t,this.retain(e),this},setLayer:function(e){this.layer=e,this.fullscreenLayer||(this.fullscreenLayer=e.above()),this._setupFullscreen()},setFullscreenEl:function(e){this.fullscreenEl=e,this._setupFullscreen()},preventDefaultEvents:function(){this.undelegateEvents(this.fullscreenEvents)},isSplittable:function(){return!1},isRearrangeable:function(){return this.$el.hasClass(u.IS_REARRANGEABLE)?!0:!1},render:function(){return this.rendered||this.isDisabled||this.isRemoved?this:(this._previousFigureEl===this.figureEl?(this.$el.append(this._previousHtml),this.renderedWidgets=this._previousRenderedWidgets||!1):(this.renderProcessedContainerContent(),this._originalHtml=this.el.outerHTML),this.rendered=!0,this)},renderProcessedContainerContent:function(){var e=this.figureEl.el.outerHTML,t=this.el.dataset.select?this.$el:n(this.el).find("[data-select]");if(t.length===0)return this.$el.append(e);t.each(function(t,r){var i,s=r.dataset.select;try{i=n(e).find(s)[0]}catch(o){}i?r.innerHTML=i.outerHTML:r.parentNode.removeChild(r)})},discard:function(){var e=n(this.figureEl.el.outerHTML);this.$el.empty().append(e),this.renderedWidgets=!1,this.renderWidgets(),this.unload(),this.load()},revertToOriginal:function(){this.$el.html(this._originalHtml)},revert:function(){this.rendered&&(this._previousHtml=this.el.innerHTML,this._previousFigureEl=this.figureEl,this._previousRenderedWidgets=this.renderedWidgets),this._originalHtml=!1,this.rendered=!1,this.renderedWidgets=!1,this.figure=null,this.figureEl=null,this.fullscreenEl=null,this.fullscreenLoaded=!1,this.releaseAll(),this.$el.empty(),this.enable()},load:function(){l.all(this._runWidgets(),this._doLoad)},unload:function(e){if(this.loaded===!1)return;var t=n(e||this.el);this.loaded=!1,t.addClass(u.CONTAINER_IS_UNLOADED),t.find("[data-src]").each(function(){this.setAttribute("src","data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==")})},addDeferred:function(e){this.deferreds.push(e)},shouldStickToNext:function(){return!1},enterFullscreen:function(e){if(!this._supportsFullscreen){f.console.warn("This container does not support fullscreen"),this.layer||f.console.warn("  Missing layer"),this.fullscreenEl||f.console.warn("  Missing fullscreenEl");return}var t=this.transition;if(this.gestureStarted||t.isRunning())return!1;this.layer.transition=t,e&&e instanceof HTMLElement&&t.setTargetEl(e),t.run()},_setupFullscreen:function(){if(this._supportsFullscreen||!(this.fullscreenEl&&this.layer&&this.fullscreenLayer))return;this.transition=this.transition||this.layer.transitionTo(this.fullscreenLayer,i.Fade),this.$el.addClass(u.SUPPORTS_FULLSCREEN),this.listenTo(this.transition,{willAppear:this._fullscreenWillAppear,didAppear:this._fullscreenDidAppear,didDisappear:this._fullscreenDidDisappear}),this.layer.transition=this.transition,this.delegateEvents(f.touchScreen?this.fullscreenEvents.touch:this.fullscreenEvents.pointer),this._supportsFullscreen=!0},_setUniqueId:function(e){return e||(e=t.uniqueId("c")),this.id=e,this.el.id=e,e},renderWidgetMatch:function(e){e.widget.render.call(e,this,e.el),e.widget.compile||(this.isDirty=!0)},renderWidgets:function(){if(this.renderedWidgets)return!1;t.each(this.matchingWidgets,function(e){(!this.decompiled||this.decompiled&&!e.widget.compile)&&this.renderWidgetMatch(e)},this),this.renderedWidgets=!0},_runWidgets:function(){var e,n=[];return t.each(this.matchingWidgets,function(t){e=l.defer(),t.widget.compile||(this.isDirty=!0),t.widget.run.call(t,e.resolve),n.push(e)},this),n},_doLoad:function(){var e=this,t=Math.min(this.options.pixelRatio,2),n;if(this.loaded)return;return this.$el.hasClass(u.ALLOW_OVERFLOW)||this._fitBoundaries(),this.$assets=this.$el.find("[data-src]"),this.$assets.each(function(){e._trackAssetProgress(this)}),l.any(this.deferreds,this._loadReady),l.all(this.deferreds,this._loadComplete),n="data-src"+(t>1?"-"+t+"x":""),this.$assets.each(function(){this.src=this.getAttribute(n)||this.getAttribute("data-src")}),this.loaded=!0,this},_fullscreenWillAppear:function(e,t){this.trigger("fullscreenWillAppear",e,t)},_fullscreenDidAppear:function(e){this.trigger("fullscreenDidAppear",e)},_fullscreenDidDisappear:function(e){this.trigger("fullscreenDidDisappear",this),a.trigger("fullscreenDidDisappear",this)},_loadReady:function(){this.$el.removeClass(u.CONTAINER_IS_UNLOADED)},_loadComplete:function(){this.trigger("loadComplete")},_trackAssetProgress:function(e){var t=l.defer(),n=this;this.addDeferred(t),c.loadedAssets.indexOf(e.getAttribute("data-src"))!==-1?t.resolve({},e):(e.addEventListener("load",function(e){c.loadedAssets.push(this.getAttribute("data-src")),t.resolve(e,this)}),e.addEventListener("error",function(e){t.resolve(e,this),a.trigger("assetLoadError",n,this.src)}))},_fitBoundaries:function(){var e=[],r=this;if(this.decompiled||this.isResponsive)return;this.$el.find("img").each(function(){var t=this.clientWidth,n=this.clientHeight,i;t>r.metrics.width&&(i=r.metrics.width/t,e.push({el:this,css:{height:n*i+"px",width:r.metrics.width+"px"}}))}),t.each(e,function(e){n(e.el).css(e.css)})},onTouchStart:function(e){e=e.originalEvent||e;var t=e.touches[0];this._touchStartX=t.pageX,this._touchStartY=t.pageY,this._touchMoveX=t.pageX,this._touchMoveY=t.pageY},onTouchMove:function(e){e=e.originalEvent||e;var t=e.touches[0];this._touchMoveX=t.pageX,this._touchMoveY=t.pageY},onTouchEnd:function(e){var t,n;t=Math.abs(this._touchStartX-this._touchMoveX),n=Math.abs(this._touchStartY-this._touchMoveY),t<7&&n<7&&e.preventDefault()},onTap:function(e){this.enterFullscreen(e.currentTarget)},onGestureStart:function(e){var t=this.transition;if(this.gestureStarted||t.isRunning())return!1;this.gestureStarted=!0,t.setTargetEl(e.currentTarget),this.startTransform(e)},onGestureChange:function(e){var t=this.transition;if(t.isRunning())return!1;this.transformEventTarget(e)},onGestureEnd:function(e){var t=this.transition;if(t.isRunning())return!1;t.run(),this.gestureStarted=!1}}),c}),define("modules/layout/Block",["require","underscore","modules/dom","modules/BaseView","modules/layout/mixins/LayoutElement","modules/classnames"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("modules/BaseView"),i=e("modules/layout/mixins/LayoutElement"),s=e("modules/classnames"),o=r.extend();return t.extend(o.prototype,i,{tagName:"p",isInline:!0,initialize:function(e){e=e||{},this.isOverflow=!1,this.isDirty=!1,this.originalMetrics=null,e.metrics||this.defaultMetrics()},render:function(){if(this.isRendered)return this;this.isLast&&this.$el.addClass(s.IS_LAST_BLOCK);if(this.isOverflow){var e=n('<div style="overflow:hidden;padding:0;"></div>');e.css("margin-bottom",this.metrics.marginBottom+"px").addClass(s.IS_SPLITTABLE).addClass(s.IS_NON_REARRANGEABLE).append(this.el),this.$el.css("margin-bottom","0px"),this.setElement(e[0]),this.isDirty=!0}return this.isRendered=!0,this},clone:function(){var e=this,n=new o({el:this.el.cloneNode(!0)});return n.clonedFrom=this,n.metrics=t.extend({},this.metrics),n.isLast=this.isLast,this.isDirty&&n.$el.removeAttr("style"),n},revert:function(){this.isDirty&&(this.isOverflow||this.el.style.removeProperty("overflow"),this.el.style.removeProperty("height"),this.isDirty=!1)},isSplittable:function(){return this.$el.hasClass(s.IS_NON_SPLITTABLE)?!1:this.$el.hasClass(s.IS_SPLITTABLE)||["P","UL","OL"].indexOf(this.el.tagName)!==-1},isRearrangeable:function(){return this.$el.hasClass(s.IS_NON_REARRANGEABLE)?!1:this.$el.hasClass(s.IS_REARRANGEABLE)||["DIV"].indexOf(this.el.tagName)!==-1},shouldStickToNext:function(){return this.$el.hasClass(s.STICK_TO_NEXT)||["H1","H2","H3"].indexOf(this.el.tagName)!==-1},getOverflowBlock:function(e){var t=this.metrics.height,n=0,r,i;i=this.clone(),i._isNormalized=!1,i.isOverflow=!0,i.overflowMarginTop=this.isOverflow?this.metrics.overflowMarginTop:0,r=e%this.metrics.lineHeight,n=e-r,this.$el.css({overflow:"hidden",height:n+"px"}),this.isDirty=!0;var s=i.overflowMarginTop;return i.$el.css("margin-top",s-n+"px"),i.metrics.height-=n,i.metrics.outerHeight-=n,i.metrics.overflowMarginTop=s-n,i}}),o}),define("modules/layout/Region",["require","underscore","modules/BaseView","modules/layout/mixins/LayoutElement","modules/layout/ContentRetainer","modules/layout/Container","modules/layout/Figure","modules/layout/Block","modules/util","modules/classnames"],function(e){var t=e("underscore"),n=e("modules/BaseView"),r=e("modules/layout/mixins/LayoutElement"),i=e("modules/layout/ContentRetainer"),s=e("modules/layout/Container"),o=e("modules/layout/Figure"),u=e("modules/layout/Block"),a=e("modules/util"),f=e("modules/classnames"),l=n.extend();return t.extend(l.prototype,r,i,{className:f.REGION,initialize:function(e){this.options=e||{},this.defaultMetrics(this.options.metrics),this.metrics.contentHeight=0,this.fragment=null,this._contentContainers=[],this.options.elements&&this.addElements(this.options.elements)},tearDown:function(){this.stopListening(),this.fragment=null,this.revert(),this.el=null,this.$el=null},clone:function(){var e=new l({el:this.el.cloneNode(!0)});return e.content=this.content,e},setElement:function(e){l.__super__.setElement.call(this,e),this._originalHtml=this.$el.html(),this.isFlexible=this.$el.hasClass(f.REGION_FLEXIBLE),this._originalContainers=this._getInlineContainers(),this.containers=this._originalContainers.slice(0)},setContent:function(e){this.content=e,this.addElements(e.getElements())},addElements:function(e){return this.$el.empty(),this.fragment=document.createDocumentFragment(),t.forEach(e,this._addElement,this),this.el.appendChild(this.fragment),this.containers=this._contentContainers,this._contentContainers=[],this},getOverflow:function(e){e=e||{};var t=e.outerHeight||0,n=0;return this.lastUsedElement&&(n=Math.min(this.lastUsedElement.metrics.marginBottom,e.marginTop)),this.metrics.contentHeight-this.metrics.height+t-n},hasSpaceLeft:function(){return this.getOverflow()<0},revert:function(e){t.invoke(this.elements,"revert"),e=e?e:this._originalHtml||"",this.metrics.contentHeight=0,this.lastUsedElement=null,this.releaseAll(),this.el.innerHTML=e,this._originalHtml=e},_addElement:function(e){var t,n;return e=this._verifyElementIsUsable(e),!e||!this.isFlexible&&this.metrics.height===0?!0:this.metrics.contentHeight!==0&&e.el&&e.$el.hasClass(f.BREAK_BEFORE)?!1:(this._verifyElementMetrics(e),n=this.getOverflow(e.metrics),this.isFlexible||n*-1>=this.metrics.lineHeight?(this._useElement(e),!0):n>-this.metrics.lineHeight&&n<=e.metrics.marginBottom?(e.shouldStickToNext()||this._useElement(e),!1):this._overflowElementIfSupported(e))},_useElement:function(e){var t=0;this.lastUsedElement&&(t=Math.min(this.lastUsedElement.metrics.marginBottom,e.metrics.marginTop));var n=e.metrics.outerHeight-t;this.metrics.contentHeight+=n,this.fragment.appendChild(e.render().el),this.retain(e.figure||e),this.lastUsedElement=e,e instanceof s&&this._contentContainers.push(e)},_overflowElementIfSupported:function(e){var t,n,r=e.isRearrangeable();return!r&&!e.isSplittable()?!1:r?(this.anchoredBlock=e,!0):(t=this.metrics.height-this.metrics.contentHeight,this._useElement(e),n=e.getOverflowBlock(t).render(),this.content.addAfter(n,this.anchoredBlock||this.lastUsedElement),this.anchoredBlock=null,!1)},_verifyElementIsUsable:function(e){if(e instanceof u)return e;if(e instanceof o&&!this._originalContainers)return!1;var n,r;return t.each(this._originalContainers,function(t){n=e.getElementMappedToField(t.fieldMap);if(n)return r=t,!1}),n?(r=r.clone(),r.isInline=!0,r.content=this.content,r.setFigure(e,n),this.$el.append(r.render().el),r.calculateMetrics(),r.metrics.lineHeight=this.metrics.lineHeight,this.options.isPositionedGrid&&r.normalize(this.metrics.lineHeight,this.lastUsedElement&&this.lastUsedElement.metrics.marginBottom),r.releaseAll(),r.$el.remove(),r):!1},_verifyElementMetrics:function(e){e.metrics.lineHeight!==this.metrics.lineHeight&&a.console.warn("lineHeight mismatch between page and content.","lineHeight on ",this.el,": ",this.metrics.lineHeight,"lineHeight on ",e.el,": ",e.metrics.lineHeight,"The page might not look good!"),this.options.isPositionedGrid&&e.normalize(this.metrics.lineHeight,this.lastUsedElement&&this.lastUsedElement.metrics.marginBottom)},_getInlineContainers:function(){return t.map(this.$el.find("."+f.CONTAINER_INLINE),function(e){return new s({el:e})})}}),l}),define("modules/layout/FullscreenContainer",["require","underscore","modules/dom","modules/BaseView","modules/layout/mixins/LayoutElement","modules/util","modules/classnames","modules/hub","when"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("modules/BaseView"),i=e("modules/layout/mixins/LayoutElement"),s=e("modules/util"),o=e("modules/classnames"),u=e("modules/hub"),a=e("when"),f=r.extend();return t.extend(f.prototype,i,{initialize:function(e){e=this.options=t.extend({},e||{}),this.layer=this.options.layer||null},tearDown:function(){this.stopListening(),this.$el.remove()},subscribeToContainer:function(e){var t;!e.fullscreenEl&&e.figure&&(t=this.getFullscreenElement(e.figure),t&&e.setFullscreenEl(t)),this.listenTo(e,{fullscreenWillAppear:function(t,n){this._loadMathchingWidgetsForContainer(e,n)}})},getFullscreenElement:function(e){var t=s.dom.getFieldMap(this.el),n=e.getElementMappedToField(t),r;return n?n.el.cloneNode(!0):null},loadContainer:function(e,t){if(!this.layer){s.console.warn("No fullscreen layer found");return}var n=this,r,i=function(){e.fullscreenLoaded=!0,t()};this.$el.empty().addClass(o.IS_VISIBLE).append(e.fullscreenEl),this.layer.renderFullscreenContainer(this);if(e.fullscreenLoaded)return i();r=this.layer.$el.find("img[data-src]"),r.length||i(),r.each(function(){this.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",this.addEventListener("load",i),this.src=this.getAttribute("data-src")})},exitFullscreen:function(){this.layer.exitFullscreen()},_loadMathchingWidgetsForContainer:function(e,n){var r=[],i=[],s;s=function(){u.trigger("fullscreenWillAppear",e),n()};if(!e.matchingWidgets||!e.matchingWidgets.length)return this.loadContainer(e,s);r.push(a.defer()),this.loadContainer(e,r[0].resolve),t.each(e.matchingWidgets,function(e){var t=a.defer();r.push(t),e.widget.fullscreen.call(e,this,t.resolve)},this),a.all(r,s)}}),f}),define("modules/layout/SizeDetector",["require","underscore","modules/dom","modules/classnames","when","modules/BaseView"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("modules/classnames"),i=e("when"),s=e("modules/BaseView"),o=navigator.userAgent.match(/Trident/),u=t.memoize(function(e){if(!e)return{};var n=e.replace(/\s+/g,"").split(";"),r={};return t.each(n,function(e){var t=e.split(":"),n=t[0],i=parseInt(t[1],10);isNaN(i)&&(i=t[1]==="false"?!1:!0),r[n]=i}),r}),a=s.extend();return t.extend(a.prototype,{tagName:"object",className:r.SIZE_DETECTOR,initialize:function(e){e=this.options=t.extend({start:300,end:1200,interval:50,refreshRate:50,watch:!0,target:null},e||{}),this.$target=n(this.options.target),t.extend(this.options,u(this.$target.attr("data-respond"))),t.bindAll(this,"_onResize","_setupListenerForView"),this._onResize=t.throttle(this._onResize,e.refreshRate),this._deferred=i.defer(),this.isReady=this._deferred.promise},start:function(){this._setupListenerForView()},tearDown:function(){var e=this.el.contentDocument;e&&e.defaultView&&e.defaultView.removeEventListener("resize",this._onResize),this.$el.remove()},render:function(){var e=this;if(!this.options.watch)return this._applyClassNamesForWidth(this.$target.width()),this._deferred.resolve(),this;var t=this.$target.find("."+r.SIZE_DETECTOR);return t.length?(this.setElement(t),this.start(),this):(this.$el.css({display:"block",position:"absolute",top:0,right:0,bottom:0,left:0,width:"100%","pointer-events":"none","z-index":-2147483648}),this.el.type="text/html",this.el.data="about:blank",this.start(),this.$target.append(this.$el),this)},getClassNamesForWidth:function(e){var t=this.options,n=t.start,r=t.end,i=t.interval,s=[];for(var o=n;o<=r;o+=i)o<e?s.push("alf-gt"+o):s.push("alf-lt"+o);return s},_onResize:function(e){var t=e.target.innerWidth;this._applyClassNamesForWidth(t)},_setupListenerForViewOnLoad:function(){this.$el.on("load",t.bind(function(){setTimeout(this._setupListenerForView,0),this.$el.off("load")},this))},_setupListenerForView:function(){if(!this.el.contentDocument){this._setupListenerForViewOnLoad();return}var e=this.el.contentDocument.defaultView;e.addEventListener("resize",this._onResize),this._applyClassNamesForWidth(e.innerWidth),this._deferred.resolve()},_applyClassNamesForWidth:function(e){var t=this.getClassNamesForWidth(e);if(this.options.target){var r=n(this.options.target).get(0),i=r.className;i=n.trim(i.replace(/alf\-(g|l)t(\d+)\s?/g,"")),i+=" "+t.join(" "),r.className=i}this.trigger("resize",e)}}),a}),function(e,t,n){var r=function(n){var r;this.options=t.extend({prefix:""},n),this.el=n.el,this.height=n.height||t(this.el).height(),this.lineHeight=n.lineHeight||0,r=e.getComputedStyle(this.el,null),this.paddingTop=parseInt(r.getPropertyValue("padding-top"),10),this.paddingBottom=parseInt(r.getPropertyValue("padding-bottom"),10),this.height-=this.paddingTop+this.paddingBottom,this._position()};r.prototype._position=function(){var e=this,n=[],r=this.el.className.match(/cols\-([0-9]+)/);if(!r)throw new Error("Failed to find number of columns");r=parseInt(r[1],10);for(var i=0;i<r;i++)n[i]={remainingHeight:this.height,cells:[]};t(this.el).find('[class*="col-"]').each(function(){var r=parseInt(this.className.match(/col\-([0-9]+)/)[1],10)-1,i=this.className.match(/colspan\-([0-9]+)/),s=e._createCellFromEl(this);i=i?parseInt(i[1],10):1;if(t(this).css("display")==="none")return;for(var o=r;o<r+i;o++)n[o].cells.push(s)}),this._calcMetrics(n),t.each(n,function(t,n){e._positionColumn(t,n)})},r.prototype._createCellFromEl=function(e){var n=t(e).hasClass(this._class("flex"));return{el:e,height:0,innerHeight:0,top:0,flex:n}},r.prototype._calcMetrics=function(n){var r,i,s,o,u,a,f,l,c,h;r=this._class("col-top"),i=this._class("col-bottom"),s=n.length;for(f=0;f<s;f++){o=n[f].cells.length;for(l=0;l<o;l++)u=n[f].cells[l],a=t(u.el),a.removeClass(r+" "+i),l===0&&(u.isTop=!0,a.addClass(r)),l===o-1&&(u.isBottom=!0,a.addClass(i))}for(f=0;f<s;f++){o=n[f].cells.length;for(l=0;l<o;l++)u=n[f].cells[l],a=t(u.el),u.height=u.flex?0:a.outerHeight(),u.isTop&&(c=e.getComputedStyle(u.el,null),marginTop=a.css("margin-top"),n[f].marginTop=parseInt(c.getPropertyValue("margin-top"),10),n[f].marginTopOffset=n[f].marginTop%this.lineHeight,u.flex||(u.innerHeight=a.height(),u.innerHeight===0&&(h=parseInt(c.getPropertyValue("margin-bottom"),10),u.height-=h))),n[f].remainingHeight-=u.height}},r.prototype._positionColumn=function(e,n){var r=this,i=this.paddingTop;t.each(n.cells,function(e,s){var o=t(s.el),u={},a=0;r.lineHeight&&!s.isTop&&(!s.isBottom||!!s.flex)&&(a=(i-n.marginTopOffset-r.paddingTop)%r.lineHeight,a!==0&&(a=r.lineHeight-a,n.remainingHeight-=a,i+=a));if(!s.isTop||s.top<i)s.top=i;u.top=s.top+"px";if(s.flex){var f=parseInt(o.css("margin-bottom"),10)+parseInt(o.css("margin-top"),10);s.height=n.remainingHeight,u.height=(s.height>f?s.height-f:0)+"px"}o.css(u),i+=s.height})},r.prototype._class=function(e){return this.options.prefix+e},t.fn.grid=function(e){return e=e||{},e.el=this[0],new r(e)},e.Grid=r}(this,window.Zepto||window.jQuery),define("grid",["zepto"],function(e){return function(){var t,n;return t||e.window.Grid}}(this)),define("modules/layout/PageTemplate",["require","modules/dom","underscore","when","modules/BaseView","modules/layout/mixins/LayoutElement","modules/layout/Region","modules/layout/Block","modules/layout/Container","modules/layout/FullscreenContainer","modules/layout/SizeDetector","modules/classnames","modules/util","grid","modules/hub"],function(e){var t=e("modules/dom"),n=e("underscore"),r=e("when"),i=e("modules/BaseView"),s=e("modules/layout/mixins/LayoutElement"),o=e("modules/layout/Region"),u=e("modules/layout/Block"),a=e("modules/layout/Container"),f=e("modules/layout/FullscreenContainer"),l=e("modules/layout/SizeDetector"),c=e("modules/classnames"),h=e("modules/util"),p=e("grid"),d=e("modules/hub"),v=i.extend();return n.extend(v.prototype,s,{initialize:function(e){this.options=e,e.page&&this.setPage(e.page),this.template=e.template||null,this.deferreds=[],this.fullscreenContainer=this._getFullscreenContainer()},tearDown:function(){this.stopListening(),n.invoke(this.containers,"tearDown"),n.invoke(this.regions,"tearDown"),this.template=null,this.containers=null,this.regions=null,this.fullscreenContainer&&this.fullscreenContainer.tearDown()},setElement:function(e){v.__super__.setElement.call(this,e),this.isPositionedGrid=!!this.el.className.match(/cols\-([0-9])+/),this.isResponsive=this.$el.hasClass(c.IS_RESPONSIVE),this.reload()},setPage:function(e){this.page=e,this.content=e.content},prepareToRender:function(){this._setupContainers(),this._renderContainers()},render:function(){return this.loadContainers(),this._fit(),this._fillRegions(),this.trackProgress(),this},reload:function(){this._findContainers(),this._findRegions()},prepareToReflow:function(){n.invoke(this.regions,"tearDown"),this._findRegions()},reflow:function(){this._fit(),this._fillRegions()},revert:function(){this._sizeListener=!1,this.stopListening(),n.invoke(this.regions,"revert"),n.invoke(this.containers,"revert")},decompile:function(){this.decompiled=!0,this.loadContainers(!0,this._getAllContainers()),this.trackProgress()},addDeferred:function(e){this.deferreds.push(e)},didRetainElements:function(){return n.some(this.containers.concat(this.regions),function(e){return e.didRetainElements()})},loadContainers:function(e,t){var r=this.deferreds;return this._setupSizeDetector(),t=t||this.containers,n.each(t,function(t){this._prepareContainerForLoad(t,e),t.load(),r=r.concat(t.deferreds)},this),this.deferreds=r,this},trackProgress:function(){var e=this.page,t=function(){e.trigger("loadComplete",e),d.trigger("loadComplete",e)};this.deferreds.length?r.all(this.deferreds,t):t()},_findContainers:function(){var e=this,t=this.containers;this.containers=n.map(this.$el.find("."+c.CONTAINER),function(r){var i;return i=n.find(t,function(e){return e.el===r}),i||(i=new a({el:r}),i.isResponsive=e.isResponsive),i})},_findRegions:function(){var e=this.regions,r=this.isPositionedGrid;this.regions=n.map(this.$el.find("."+c.REGION),function(i){return n.find(e,function(e){return e.el===i})||new o({el:i,isPositionedGrid:r||t(i).closest(".alf-grid",this.$el).length>=1})},this)},_getAllContainers:function(){var e=n.flatten(n.pluck(this.regions,"containers"));return e.concat(this.containers)},_setupSizeDetector:function(){if(!this.isResponsive)return;if(this.sizeDetector){this.sizeDetector.start();return}this.sizeDetector=(new l({target:this.el})).render()},_setupContainers:function(){function t(t,r){var i,s;if(t.isRemoved||t.isDisabled||t.rendered)return;i=n.filter(e,function(e){return r.call(this,t,e)}),t.matchingFigures=i;if(!i.length){t.isOptional&&t.disable();return}s=i[0],t.ref&&(s.ref=t.ref),t.content=this.content,t.setFigure(s,s.mappedEl)}function r(e,t){if(!t.retained){var n=t.getElementMappedToField(e.fieldMap);if(n)return t.mappedEl=n,t}return!1}function i(e,t){return e.ref&&e.ref===t.ref?t:!1}var e=this.page.content.getFigures();n.each(this.containers,function(e){e.fieldMap.length&&t.call(this,e,r)},this),n.each(this.containers,function(e){e.fieldMap.length||t.call(this,e,i)},this)},_getFullscreenContainer:function(){var e=this.$el.find("."+c.CONTAINER_FULLSCREEN)[0];return e?new f({el:e.cloneNode(!0),page:this,layer:this.page?this.page.fullscreenLayer:!1,revision:this.page&&this.page.options.revision}):!1},_fit:function(){var e=this.page.metrics,r={lineHeight:e.lineHeight,prefix:"alf-"},i=this.$el.find(".alf-grid");this.isPositionedGrid&&this.$el.grid(r),i.length&&i.each(function(){t(this).grid(r)}),n.each(this.regions,function(t){t.metrics=t.$el.metrics(),t.metrics.contentHeight=0,t.metrics.lineHeight=e.lineHeight},this)},_renderContainers:function(){return n.invoke(this.containers,"render"),this},_prepareContainerForLoad:function(e,t){var n,r;n=this.page.widgets,r=this.fullscreenContainer,e.page=this.page,e.setLayer(this.page.layer),e.matchingWidgets=n.getMatchesForContainer(e),e.options.pixelRatio=this.page.options.pixelRatio,e.renderWidgets(),e.unload(),t||(e.metrics=e.$el.metrics(),this.isResponsive||e.normalize()),r&&r.subscribeToContainer(e)},_fillRegions:function(){var e=this.page.content,t=e.getBlocks(),n=[],r=0,i=this.regions[r];while(i){i.setContent(e),i.containers.length&&(n=n.concat(i.containers));if(!e.hasBlocksLeft())break;i=this.regions[++r]||!1}this.loadContainers(!0,n)}}),v}),define("modules/compile/Container",["require","underscore","modules/dom","modules/Base","modules/layout/PageTemplate","modules/classnames"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("modules/Base"),i=e("modules/layout/PageTemplate"),s=e("modules/classnames"),o=r.extend({initialize:function(e){this.container=e,this.compiled={}},compile:function(){var e,t;return e=this.container,t=n(e.el.outerHTML),e.isDirty&&e.revertToOriginal(),e.unload(t),this.compiled={loaded:e.loaded,metrics:e.metrics,html:t[0].outerHTML},e.fullscreenEl&&(this.compiled.fullscreenEl=e.fullscreenEl.outerHTML),this.compiled},decompile:function(e){var r=this.container;r.decompiled=!0,t.extend(r,e),r.fullscreenEl&&r.setFullscreenEl(n(r.fullscreenEl).get(0))}});return o}),define("modules/compile/Page",["require","underscore","modules/dom","modules/Base","modules/layout/PageTemplate","modules/classnames","modules/compile/Container","when"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("modules/Base"),i=e("modules/layout/PageTemplate"),s=e("modules/classnames"),o=e("modules/compile/Container"),u=e("when"),a={classNames:[s.IS_DRAGGABLE,s.IS_DRAGGABLE_X,s.IS_DRAGGABLE_Y,s.IS_EDITABLE,s.IS_OPTIONAL,s.IS_REMOVABLE,s.IS_RESIZABLE],attributes:["data-filter-format-name","data-filter-page-pos","data-map","data-media","data-name","data-score"],elements:["."+s.SIZE_DETECTOR]},f=r.extend({initialize:function(e){t.bindAll(this,"_doDecompile"),this.page=e,this.compiled={v:1,elements:{},assets:{images:[]}}},compile:function(){var e;return this.page.lockSize(),this.compiled.html=this._getCompiledHtml(),this._compileImages(),this._compileStylesheets(),this.compiled.assets.revision=this.page.options.revision,this.compiled},decompile:function(e,r){var s,o;r=r||function(){},this.page.decompiled=!0,this.compiledObject=t.isObject(e)?e:JSON.parse(e),this.compiledObject.assets.revision&&(this.page.options.revision=this.compiledObject.assets.revision),o=n(this.compiledObject.html).get(0),this.page.pageTemplate=new i({el:o.children[0],page:this.page}),this.page.setElement(o),this.promises=this.loadStylesheets(this.compiledObject.assets.stylesheets),u.all(this.promises).then(this._doDecompile).then(r)},strip:function(e){var r=n(e),i;i="."+a.classNames.join(", ."),r.find("."+s.IS_DISABLED+", ."+s.IS_REMOVED).remove(),r.find(i).removeClass(a.classNames.join(" ")),t.each(a.attributes,function(e){r.find("["+e+"]").removeAttr(e)}),t.each(a.elements,function(e){r.find(e).remove()})},_doDecompile:function(){this.page.containers=this.page.pageTemplate.containers,this.page.regions=this.page.pageTemplate.regions,t.each(this.page.pageTemplate._getAllContainers(),function(e){this.page.layer&&e.setLayer(this.page.layer),this._decompileContainer(e,this.compiledObject.elements[e.id])},this)},_decompileContainer:function(e,t){(new o(e)).decompile(t)},_getCompiledHtml:function(){var e,r,i,s;return e=n(this.page.el.outerHTML),r=this.compiled,i=this.page.pageTemplate._getAllContainers(),t.each(i,function(i){var u=(new o(i)).compile();if(i.isDisabled||i.isRemoved)return;r.elements[i.id]=u,i.fullscreenEl&&(s=n(i.fullscreenEl).find("img[data-src]"),s.length>0&&(r.assets.images=r.assets.images.concat(t.toArray(s)))),e.find("#"+i.id).replaceWith(u.html),delete u.html}),this.strip(e),e[0].outerHTML},_compileImages:function(){var e,n=this.compiled;e=this.page.$("img[data-src]"),e.length>0&&(n.assets.images=n.assets.images.concat(t.toArray(e))),n.assets.images=t.map(n.assets.images,this._compileImageAsset,this)},_compileImageAsset:function(e){var t=n(e),r={},i=t.attr("data-src-2x");return r["1x"]=t.attr("data-src"),i&&(r["2x"]=i),{height:parseInt(t.attr("height"),10),width:parseInt(t.attr("width"),10),urls:r}},_compileStylesheets:function(){this.compiled.assets.stylesheets=t.map(n("."+s.ASSET_STYLESHEET),function(e){return e.href})},loadStylesheets:function(e){e=t.map(e,function(e){return e.indexOf("://")===-1?this.page.options.assetsBaseUrl+e:e},this);var r=t.filter(n("."+s.ASSET_STYLESHEET),function(e){return this.page.options.revision===e.getAttribute("data-revision")},this),i=[],o;return t.each(r,function(t){var r=n(t),i=e.indexOf(r.attr("href"));if(i!==-1){e.splice(i,1);return}e.length?(o=e.shift(),r.attr("href",o),this._trackStylesheetProgress(o)):r.remove()},this),t.each(e,function(e){var t=n('<link rel="stylesheet" type="text/css">');t.attr({"class":s.ASSET_STYLESHEET,"data-revision":this.page.options.revision}),n("head").append(t.attr("href",e)),i.push(this._trackStylesheetProgress(e))},this),i},_trackStylesheetProgress:function(e){var t,n;return t=u.defer(),n=document.createElement("img"),this.page.pageTemplate.addDeferred(t),n.onerror=function(){t.resolve()},n.src=e,t}});return f}),define("modules/layout/Template",["require","modules/dom","underscore","modules/BaseView","modules/layout/Region","modules/layout/Container","modules/layout/Figure","modules/util","modules/classnames"],function(e){var t=e("modules/dom"),n=e("underscore"),r=e("modules/BaseView"),i=e("modules/layout/Region"),s=e("modules/layout/Container"),o=e("modules/layout/Figure"),u=e("modules/util"),a=e("modules/classnames"),f={EMPTY_CONTAINER:-500,MATCHING_CONTAINER:100,NON_MATCHING_OPTIONAL_CONTAINER:0,EMPTY_REGIONS:-500,MATCHING_REGION:100,FIGURE_DISTANCE_FACTOR:5},l=r.extend();return n.extend(l.prototype,{setElement:function(e){l.__super__.setElement.call(this,e),this.name=this.$el.attr("data-name"),this.signature=undefined,this.lockSignature(),this.containers=this.$el.find("."+a.CONTAINER).map(function(){return new s({el:this})}),this.regions=this.$el.find("."+a.REGION).map(function(){return new i({el:this})}),this.baseScore=parseInt(this.$el.attr("data-score")||0,10)},score:function(e,t){var r=this.el.getAttribute("data-name"),i=this.baseScore,s=e.content.getBlocks(),o=e.content.getFigures(),u=0;return t=t||this.getContainerMap(e.content),i+=t.score||0,n.each(t.positions,function(e){e.match?i+=e.noScore?0:f.MATCHING_CONTAINER:i+=e.isOptional?f.NON_MATCHING_OPTIONAL_CONTAINER:f.EMPTY_CONTAINER}),this.regions.length&&(i+=s.length?f.MATCHING_REGION:f.EMPTY_REGIONS),this.lastScore=i,i},getContainerMap:function(e){var t={matches:0,positions:{},score:0,template:this},r=[],i,s,u;return i=e.getElements(),s=e.getFigures(),u=i.length,n.each(this.containers,function(e,n){var a,l,c;c=t.positions[n]={match:!1,fieldMap:e.fieldMap,isOptional:e.isOptional||!e.fieldMap.length&&e.ref};for(a=0;a<u;a++){if(!(i[a]instanceof o&&r.indexOf(i[a])===-1))continue;l=i[a].getElementMappedToField(e.fieldMap);if(l){t.score-=a*f.FIGURE_DISTANCE_FACTOR,t.matches+=1,r.push(i[a]),c.match=!0,c.index=s.indexOf(i[a]),c.noScore=l.noScore;return}}}),t}}),l}),define("modules/layout/filters/article",["require","underscore","modules/util"],function(e){var t=e("underscore"),n=e("modules/util"),r=!!n.matchMedia;return{mediaQuery:function(e,i){return r?t.filter(i,function(e){var t=n.dom.getMediaQuery(e.el);return t?n.matchMedia(t).matches:!0}):i},fieldMap:function(e,r){var i=e.content.fieldMap,s;return!i||!i.length?r:t.filter(r,function(e){return s=n.dom.getFieldMap(e.el),s.length?t.intersection(i,s).length>0:!1})},emptyContainers:function(e,n){var r;return r=function(e){return e.match===!0||e.match===!1&&e.isOptional},t.filter(n,function(n){var i=n.getContainerMap(e.content);return t.every(i.positions,r)})},formatName:function(e,n){var r;return!e.format||!(r=e.format.get("name"))?n:t.filter(n,function(e){var t=e.$el.attr("data-filter-format-name");return t?t.split(" ").indexOf(r)!==-1:!0})}}}),define("modules/layout/filters/page",["require","underscore"],function(e){var t=e("underscore");return{emptyBlocks:function(e,n){var r=e.content.getBlocks(),i=e.content.getFigures();return r.length?n:t.filter(n,function(e){var n=e.regions;return n.length?t.any(n,function(e){return e.containers.length?t.any(e.containers,function(e){return t.any(i,function(t){return t.getElementMappedToField(e.fieldMap)})}):!1}):e})},emptyContainers:function(e,n){var r;return r=function(e){return e.match===!0||e.match===!1&&e.isOptional},t.filter(n,function(n){var i=n.getContainerMap(e.content);return t.every(i.positions,r)})},pagePosition:function(e,n){return t.filter(n,function(n){var r=n.$el.attr("data-filter-page-pos"),i=e.pageNum+1,s=!1;return r?(r=r.split(" "),t.each(r,function(e){var t=!1,n=parseInt(e,10);e[0]==="!"&&(t=!0,n=parseInt(e.substr(1),10));if(t&&n!==i||!t&&n===i)return s=!0,!1}),s):!0})}}}),define("modules/layout/TemplateManager",["require","underscore","modules/layout/Template","modules/layout/filters/article","modules/layout/filters/page","modules/util","modules/layout/PageTemplate"],function(e){function u(e,t){return{callback:e,name:t}}var t=e("underscore"),n=e("modules/layout/Template"),r=e("modules/layout/filters/article"),i=e("modules/layout/filters/page"),s=e("modules/util"),o=e("modules/layout/PageTemplate"),a={filters:{article:t.map(r,u),page:t.map(i,u)},addArticleFilter:function(e,t){this.filters.article.push({callback:e,name:t||"articlefilter"})},addPageFilter:function(e,t){this.filters.page.push({callback:e,name:t||"pagefilter"})},getBestTemplateForPage:function(e,n){var r,i,s={score:-Infinity,template:null,containerMap:null};return t.each(n,function(t){r=t.getContainerMap(e.content),i=t.score(e,r);if(i>s.score||i===s.score&&Math.random()>.5)s.score=i,s.template=t,s.containerMap=r}),s},getEligibleTemplatesForArticle:function(e,t){return this._filterTemplates("article",e,t)},getEligibleTemplatesForPage:function(e,t){return this._filterTemplates("page",e,t)},getScoredTemplatesForPage:function(e,n){return t.map(this.getEligibleTemplatesForPage(e,n),function(t){return{template:t,score:t.score(e)}})},getPageTemplateFromTemplate:function(e,n){return new o(t.extend(n||{},{el:e.el.cloneNode(!0)}))},getTemplateFromPageTemplate:function(e,r){var i;return i=new n(t.extend(r||{},{el:e.el.cloneNode(!0)})),t.each(i.regions,function(t,n){t.revert(e.regions[n]._originalHtml)}),t.invoke(i.containers,"revert"),i},_filterTemplates:function(e,n,r){return n.pages?s.console.groupCollapsed("** Filtering templates for article"):s.console.groupCollapsed("** Filtering templates for page",n.pageNum+1),t.each(this.filters[e],function(e){var i=r.slice(0);r=e.callback.call(this,n,r),s.console.groupCollapsed("Filter `"+e.name+"` on",i.length,"templates (removed",i.length-r.length,"templates)"),i.length-r.length&&t.each(i,function(e){r.indexOf(e)===-1&&s.console.debug("-",e.name)}),s.console.groupEnd()},this),s.console.debug("Remaining templates:",r.length),s.console.groupEnd(),r}};return a}),define("modules/layout/Page",["require","modules/dom","underscore","modules/BaseView","modules/layout/Format","modules/layout/Figure","modules/compile/Page","modules/layout/PageTemplate","modules/layout/TemplateManager","modules/layout/mixins/LayoutElement","modules/layout/mixins/Widgetable","modules/classnames","modules/util","when"],function(e){var t=e("modules/dom"),n=e("underscore"),r=e("modules/BaseView"),i=e("modules/layout/Format"),s=e("modules/layout/Figure"),o=e("modules/compile/Page"),u=e("modules/layout/PageTemplate"),a=e("modules/layout/TemplateManager"),f=e("modules/layout/mixins/LayoutElement"),l=e("modules/layout/mixins/Widgetable"),c=e("modules/classnames"),h=e("modules/util"),p=e("when"),d=r.extend();return n.extend(d.prototype,f,l,{className:"page",initialize:function(e){e=this.options=n.extend({revision:"no-rev"},e||{}),n.bindAll(this,"render"),this.decompiled=!1,this.pageNum=typeof e.pageNum=="number"?e.pageNum:null,this.className=e.className||"",this.content=e.content||null,this.layer=e.layer||null,this.fullscreenLayer=e.fullscreenLayer||this.layer&&this.layer.above()||null,this.templateManager=e.templateManager||a,this.format=e.format||null,e.pixelRatio=parseInt(e.pixelRatio||window.devicePixelRatio||1,10),this.defaultMetrics(e.metrics),this.setupWidgets(e)},tearDown:function(){this.el=null,this.pageTemplate&&this.pageTemplate.tearDown(),this.pageTemplate=null,this.content=null,this.fullscreenLayer&&this.fullscreenLayer.hide()},revert:function(){this.rendered=!1,this.pageTemplate.revert()},restoreFromHtml:function(e){this.setElement(t(e)),this.setPageTemplate(new u({el:this.el.children[0]})),this.rendered=!0},getBestTemplate:function(){var e;return e=this.templateManager.getBestTemplateForPage(this,this.templates),e.template?e:(h.console.warn("No template found for page "+this.pageNum+"! Remaining elements: "+this.content.elementsLeft),!1)},setupBestTemplate:function(){var e=this.getBestTemplate();return e?(this.setTemplate(e.template,e.containerMap,e.score),!0):!1},setTemplate:function(e,t){return this.rendered=!1,this.score=t||0,this.template===e?(this.pageTemplate.reload(),this):(this.template=e,this.setPageTemplate(this.templateManager.getPageTemplateFromTemplate(e,{page:this})),this)},setTemplateIfUsable:function(e){var t,r=e.getContainerMap(this.content);return t=!e.containers||!e.containers.length,t=t||n.all(r.positions,function(e){return e.isOptional||e.match}),t?(this.setTemplate(e,r),!0):(h.console.warn("Page ",this.pageNum,": Template ",e.name,"is no longer usable"),!1)},setPageTemplate:function(e){this.pageTemplate=e,this.$el.empty(),this.$el.append(this.pageTemplate.el),this.containers=this.pageTemplate.containers,this.regions=this.pageTemplate.regions},prepareToRender:function(){var e=[];if(this.rendered||!this.template)return this;this.className&&e.push(this.className),e.push(c.REVISION(this.options.revision)),e.push(c.PAGENUM_X(this.pageNum+1)),this.$el.addClass(e.join(" ")),this.pageTemplate.prepareToRender()},render:function(e){var t=this,n;return!this.rendered&&this.decompiled?this._renderCompiled(e):this._pendingReflow?(this._pendingReflow=!1,this.reflow(),this):this.template?this.rendered?(this.pageTemplate.loadContainers(),this):(this._setupMetrics(),this.pageTemplate.render(),this.rendered=!0,e&&this._appendToEl(e),this):this},allPagesDidRender:function(e){var t,n=c.PAGENUM_X("last"),r=c.PAGENUM_TOTAL_X(""),i=[c.PAGENUM_TOTAL_X(e)];t=new RegExp(" ?("+n+"|"+r+"[\\d]*)","g"),e===this.pageNum+1&&i.push(n),this.el.className=this.el.className.replace(t,""),this.$el.addClass(i.join(" "))},play:function(){this.$el.addClass(c.IS_PLAYING)},stop:function(){this.$el.removeClass(c.IS_PLAYING)},prepareToReflow:function(){this.pageTemplate.prepareToReflow()},reflow:function(){if(!this.isInDOM()){this._pendingReflow=!0;return}this.pageTemplate.reflow()},lockSize:function(){if(this.pageTemplate.isResponsive)return;this.$el.css({width:this.metrics.width+"px",height:this.metrics.height+"px",overflow:"hidden",position:"relative"})},compile:function(){var e=new o(this);return e.compile()},decompile:function(e,t){var n=new o(this);return n.decompile(e,t),this},_renderCompiled:function(e){return e&&this._appendToEl(e),this._setupMetrics(),this.pageTemplate.decompile(),this.rendered=!0,this},_appendToEl:function(e){var n=this.el;setTimeout(function(){t(e).empty().append(n)},0)},_setupMetrics:function(){var e=this.$el.metrics();this.format&&this.format instanceof i&&(e.height=this.format.get("height"),e.width=this.format.get("width")),!e.height&&this.metrics.height&&(e.height=this.metrics.height,e.outerHeight=this.metrics.outerHeight),this.metrics=e,this.pageTemplate.metrics=e,e.contentHeight=e.height-e.marginHeight-e.paddingTop-e.paddingBottom,e.contentWidth=e.width-e.marginWidth-e.paddingRight-e.paddingLeft}}),d}),define("modules/compile/Article",["require","underscore","modules/dom","modules/Base","modules/layout/Page","modules/classnames"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("modules/Base"),i=e("modules/layout/Page"),s=e("modules/classnames"),o=r.extend({initialize:function(e){this.article=e,this.compiled={}},compile:function(){var e=this.article.content.toJSON(),r;return e.meta.articleId=e.meta.articleId||e.meta.id,delete e.meta.id,r=t.map(n("."+s.ASSET_STYLESHEET),function(e){return e.href}),e.compiled={},e.compiled.pages=t.map(this.article.pages,function(e){return e.compile()}),e.compiled.assets={stylesheets:r,revision:this.article.options.revision},e},decompile:function(e){var n=t.isObject(e)?e:JSON.parse(e),r=n.compiled.assets.revision;r&&(this.article.options.revision=r),this.article.pages=t.map(n.compiled.pages,function(e){var t=new i({revision:r,assetsBaseUrl:n.service.assetsBaseUrl});return t.decompile(e),t})}});return o}),define("modules/layout/Content",["require","underscore","modules/dom","modules/util","modules/BaseModel","modules/layout/Block","modules/layout/Figure"],function(e){function t(e){return function(t){return t instanceof e}}var n=e("underscore"),r=e("modules/dom"),i=e("modules/util"),s=e("modules/BaseModel"),o=e("modules/layout/Block"),u=e("modules/layout/Figure"),a=s.extend({defaults:{contents:{},meta:{}},initialize:function(e){var t,n;e&&e.contents&&this._changeContents(),this.on("change:contents",this._changeContents),this.__defineGetter__("elementsLeft",this._getElementsLeft)},setElements:function(e){e=n.filter(e,function(e){return e.tagName==="P"&&e.innerHTML.length<15&&!e.innerHTML.replace(/(\s+)?(<br(\s+)?\/?>)?(&nbsp;)?/gmi,"")?!1:e}),this.elements=n.map(e,function(e){var t={el:e},n;return e.tagName==="FIGURE"?n=new u(t):n=new o(t),n});var t=this.getBlocks();t.length&&(t[t.length-1].isLast=!0)},addAfter:function(e,t){var n=this.elements;n.splice(n.indexOf(t)+1,0,e)},each:function(e,t){n.each(this.elements,e,t||this)},release:function(e){e=n.isArray(e)?e:[e],n.each(e,function(e,t){e.retained=!1,e.clonedFrom&&!e.clonedFrom.retained?this.elements.splice(this.elements.indexOf(e),1):e.revert&&e.revert()},this)},releaseAll:function(){this.release(this.elements)},retain:function(e){var t=this.elements,r=n.isArray(e)?e:[e];n.each(r,function(e){e.retained=!0})},retainAll:function(){n.each(this.elements,function(e){e.retained=!0})},getElements:function(){return n.filter(this.elements,function(e){return!e.retained})},getBlocks:function(){return n.filter(this.elements,function(e){return!e.retained&&e instanceof o})},getFigures:function(){return n.filter(this.elements,function(e,t){return!e.retained&&e instanceof u})},hasBlocksLeft:function(){return this.getBlocks().length>0},isEmpty:function(){return this.elementsLeft===0},_changeContents:function(){var e,t;e=r(this.get("contents").source),t=e.children(),this.className=e.attr("class"),this.fieldMap=i.dom.getFieldMap(e[0]),this.setElements(t)},_getElementsLeft:function(){return n.reduce(this.elements,function(e,t){return t.retained?e:e+1},0)}});return a}),define("modules/layout/Article",["require","modules/dom","underscore","modules/util","modules/BaseView","modules/layout/mixins/Widgetable","modules/layout/mixins/LayoutElement","modules/compile/Article","modules/layout/Format","modules/classnames","modules/layout/TemplateManager","modules/layout/Page","modules/layout/Content"],function(e){var t=e("modules/dom"),n=e("underscore"),r=e("modules/util"),i=e("modules/BaseView"),s=e("modules/layout/mixins/Widgetable"),o=e("modules/layout/mixins/LayoutElement"),u=e("modules/compile/Article"),a=e("modules/layout/Format"),f=e("modules/classnames"),l=e("modules/layout/TemplateManager"),c=e("modules/layout/Page"),h=e("modules/layout/Content"),p=i.extend();return n.extend(p.prototype,o,s,{initialize:function(e){e=this.options=n.extend({revision:"no-rev"},e||{}),n.bindAll(this,"render"),this.templates=null,this.overrideTemplates={},this.layer=e.layer||null,this.fullscreenLayer=e.fullscreenLayer||this.layer&&this.layer.above()||null,this.pages={},this.numberOfPages=0,this.format=e.format||null,this.defaultMetrics(e.metrics),e.content&&this.setContent(e.content),this.setupWidgets(e),e.templates&&this.setTemplates(e.templates)},tearDown:function(){n.invoke(this.pages,"tearDown")},render:function(){return this},discard:function(){n.invoke(this.pages,"tearDown"),this.pages={},this.overrideTemplates={},this.numberOfPages=0},compile:function(){var e=new u(this);return e.compile()},decompile:function(e){var t=new u(this);return t.decompile(e),this},setTemplates:function(e){var t=this.templates||[];e=l.getEligibleTemplatesForArticle(this,e);if(!t||!t.length){this.templates=e;return}this.templates=n.map(e,function(e){var r=n.find(t,function(t){return t.name===e.name});return r&&(r.setElement(e.el),this._reloadPagesUsingTemplate(r)),r||e},this)},_reloadPagesUsingTemplate:function(e){n.each(this.pages,function(t){t.template===e&&(t.template=null,t.setTemplateIfUsable(e))})},setTemplateForPageNum:function(e,t){this.overrideTemplates[t]=e,this.pages[t]&&(this.pages[t].hasOverrideTemplate=!0)},revert:function(e){for(var t in this.pages){if(t<e||!this.pages[t])continue;this.pages[t].revert()}},reflow:function(e){n.each(["prepareToReflow","reflow"],function(t){for(var n in this.pages){if(n<e||!this.pages[n])continue;this.pages[n][t]()}},this)},renderPage:function(e,r){var i,s;return this._calcContentMetrics(e),i=n.isObject(r)?r:this._getOrCreatePageForPageNum(r),s=this.overrideTemplates[i.pageNum],i.prepareToRender(),e.innerHTML="",t(e).append(i.el),i.render(),i.hasOverrideTemplate=!!s&&s===i.template,i},renderPages:function(e,t){var r;t=t||0,this._calcContentMetrics(e);while(!this.content.isEmpty()){r=this._doRenderPage(e,t);if(!r)break;this.pages[t]=r,t+=1}return this.numberOfPages=this.getNumberOfPagesInUse(),n.invoke(this.pages,"allPagesDidRender",this.numberOfPages),this},getNumberOfPagesInUse:function(){var e=0;for(var t in this.pages)this.pages[t].pageTemplate.didRetainElements()?e+=1:(this.pages[t].tearDown(),delete this.pages[t]);return e},setContent:function(e){if(e instanceof h)this.content=e;else{if(!n.isPlainObject(e))throw new Error("Unsupported data in setContent: "+typeof e);this.content=new h(e)}},findContainerInElement:function(e){var r,i;return i=t(e),i=i.is("."+f.CONTAINER)?i:i.find("."+f.CONTAINER),i.length?(n.each(this.pages,function(e){r=n.find(e.pageTemplate.containers,function(e){return e.el===i[0]});if(r)return!1}),r):!1},_getOrCreatePageForPageNum:function(e){var t=this.pages[e],r=this.overrideTemplates[e],i;return t||(t=this.createPage(e)),t.rendered?t:(t.scoredTemplates=l.getScoredTemplatesForPage(t,this.templates.slice(0)),t.templates=n.pluck(t.scoredTemplates,"template"),r&&t.setTemplateIfUsable(r)||t.setupBestTemplate()?t:!1)},createPage:function(e){var t=this.metrics;return new c({className:this.content.className,content:this.content,layer:this.layer,fullscreenLayer:this.fullscreenLayer,widgets:this.widgets,fullscreenWidgets:this.fullscreenWidgets,pageNum:e,format:this.format,revision:this.options.revision,metrics:{height:t.height,width:t.width,lineHeight:t.lineHeight}})},_doRenderPage:function(e,t){var n=0,i,s;for(;;){i=this._getOrCreatePageForPageNum(t);if(!i)return!1;this.renderPage(e,i);if(i.pageTemplate.didRetainElements())return i;r.console.warn("Page "+t+" did not retain any elements on attempt "+n,"left:",this.content.elementsLeft),n+=1;if(n>1||!this.overrideTemplates[t])return r.console.warn("stopped trying after "+n+" attempts"),!1;this.overrideTemplates[t]=null}},_getSampleTemplate:function(){var e=0;return n.find(this.templates,function(n){return n.regions&&n.regions.length>e})},_calcContentMetrics:function(e){if(this.hasCalculatedMetrics)return;this.setMetrics(t(e).metrics()),this.format&&this.format instanceof a&&(this.metrics.height=this.format.get("height"),this.metrics.width=this.format.get("width"));var n=this._getSampleTemplate(),i;if(!n){r.console.warn("No sample template found. Failed to precalculate metrics for ",this);return}n=l.getPageTemplateFromTemplate(n),i=n.regions,n.$el.css("visibility","hidden"),n.$el.addClass(f.REVISION(this.options.revision)),e.appendChild(n.el),this._calcBlockMetrics(i[0].el),e.removeChild(n.el),i[0].$el.empty(),this.hasCalculatedMetrics=!0},_calcBlockMetrics:function(e){var t=this.content.getBlocks(),r=document.createDocumentFragment(),i=this.metrics;n.each(t,function(t){r.appendChild(t.render().el)}),e.appendChild(r),n.each(t,function(t){t.calculateMetrics()})}}),p}),define("modules/layout",["require","modules/layout/Article","modules/layout/Page","modules/layout/Template","modules/layout/TemplateManager","modules/layout/Content","modules/layout/Format"],function(e){return{Article:e("modules/layout/Article"),Page:e("modules/layout/Page"),Template:e("modules/layout/Template"),TemplateManager:e("modules/layout/TemplateManager"),Content:e("modules/layout/Content"),Format:e("modules/layout/Format")}}),define("modules/serialize/Page",["require","underscore","modules/dom","md5","modules/Base","modules/layout/Page","modules/layout/Template","modules/layout/TemplateManager"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("md5"),i=e("modules/Base"),s=e("modules/layout/Page"),o=e("modules/layout/Template"),u=e("modules/layout/TemplateManager"),a=i.extend({initialize:function(e,t){this.page=e,this.article=t},serialize:function(){var e=[],n=this.page;return this.article.overrideTemplates[n.pageNum]?(e=t.map(n.pageTemplate.containers,function(e){return{figureElementSignature:e.figureEl&&e.figureEl.getSignature(),html:e.el.innerHTML}}),{template:{signature:n.template.getSignature(),html:u.getTemplateFromPageTemplate(n.pageTemplate).el.outerHTML},containers:e}):!1},unserialize:function(e){var t,r,i,s,a;return s=e.templateHash||e.template.signature,a=e.templateHtml||e.template.html,r=new o({el:n(a)}),t=this._findOriginalTemplate(s),this.page=this.article.createPage(e.pageNum),this.page.setTemplate(t||r),i=u.getPageTemplateFromTemplate(r,{page:this.page}),this.page.setPageTemplate(i),this._mapContainers(e),this.page},_findOriginalTemplate:function(e){return t.find(this.article.templates,function(t){return t.getSignature()===e})},_mapContainers:function(e){this.page.pageTemplate._setupContainers(),t.each(this.page.pageTemplate.containers,function(n,r){var i;i=t.any(n.matchingFigures,function(i){var s=t.find(i.elements,function(t){return t.getSignature()===e.containers[r].figureElementSignature});return s&&(n.revert(),n.setFigure(i,s)),s}),n.render(),i=i||n.matchingFigures&&n.matchingFigures.length===1,i&&(n.el.innerHTML=e.containers[r].html,n.renderedWidgets=!0)})}});return a}),define("modules/serialize/Article",["require","underscore","modules/dom","md5","modules/Base","modules/layout/Article","modules/serialize/Page"],function(e){var t=e("underscore"),n=e("modules/dom"),r=e("md5"),i=e("modules/Base"),s=e("modules/layout/Article"),o=e("modules/serialize/Page"),u=i.extend({initialize:function(e){this.article=e},serialize:function(){return{pages:t.map(this.article.pages,this._serializePage,this)}},unserialize:function(e){var n,r=[];return n=new o(null,this.article),e=typeof e=="string"?JSON.parse(e):e,t.each(e.pages,function(e,t){if(!e)return;e.pageNum=t,r.push(n.unserialize(e))}),t.each(r,function(e){this.article.pages[e.pageNum]=e,this.article.setTemplateForPageNum(e.template,e.pageNum)},this),this.article.revert(),this.article},_serializePage:function(e){var t=new o(e,this.article);return t.serialize()}});return u}),define("modules/serialize",["require","modules/serialize/Article"],function(e){return{Article:e("modules/serialize/Article")}}),define("modules/compile",["require","modules/compile/Article"],function(e){return{Article:e("modules/compile/Article")}}),define("modules/nav",["require","modules/nav/ScrollView"],function(e){return{ScrollView:e("modules/nav/ScrollView")}}),define("alf",["require","modules/dom","underscore","modules/hub","modules/Base","modules/BaseView","vendor/queue","backbone","modules/transition","modules/layer","modules/layout","modules/serialize","modules/compile","modules/nav","modules/util"],function(e){return{dom:e("modules/dom"),_:e("underscore"),hub:e("modules/hub"),Base:e("modules/Base"),View:e("modules/BaseView"),Queue:e("vendor/queue"),Events:e("backbone").Events,transition:e("modules/transition"),layer:e("modules/layer"),layout:e("modules/layout"),serialize:e("modules/serialize"),compile:e("modules/compile"),nav:e("modules/nav"),util:e("modules/util")}}),require(["require","alf"]),define("main-no-deps",function(){});